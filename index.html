<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordo Rex Luciferi | A Chama Negra</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        // üîÆ CONFIGURA√á√ÉO VISUAL - TEMA LUCIFERIANO üîÆ
        const CURRENT_THEME = 'RexLucifer'; 

        const THEMES = {
            'RexLucifer': { 
                name: 'Lux Tenebris', 
                primary: { 400: '#FFD700', 500: '#B8860B', 900: '#1C1C1C' }, // Ouro Imperial e Sombra
                accent: '#8B0000', // Sangue Carmesim
                particle: 'üî•' // Fogo da Ilumina√ß√£o
            }
        };

        const activeTheme = THEMES[CURRENT_THEME];

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        void: '#000000', // Preto absoluto
                        primary: activeTheme.primary,
                        obsidian: '#0a0a0a', // Quase preto
                        accent: activeTheme.accent,
                        royal: '#1a1a1a'
                    },
                    fontFamily: {
                        display: ['Cinzel', 'serif'], // Fonte com serifa majestosa
                        body: ['Lato', 'sans-serif'],
                    },
                    animation: { 
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'spin-slow': 'spin 12s linear infinite',
                        'fade-in-slow': 'fadeIn 2s ease-in forwards',
                        'float': 'float 6s ease-in-out infinite'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700;900&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        /* ESTILOS GERAIS */
        body { background-color: #000; color: #d4d4d4; overflow-x: hidden; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(to bottom, var(--accent-color), var(--primary-color)); border-radius: 3px; }

        .glass-dark {
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 215, 0, 0.05); /* Borda dourada sutil */
        }

        /* TEXTO DOURADO BRILHANTE */
        .text-gradient-gold {
            background: linear-gradient(to right, #B8860B, #FFD700, #F0E68C, #B8860B);
            -webkit-background-clip: text; background-clip: text; color: transparent; 
            background-size: 300% auto; animation: shine 6s linear infinite;
        }
        @keyframes shine { to { background-position: 300% center; } }
        
        .fade-in-up { animation: fadeInUp 0.8s ease-out forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        
        /* INPUTS ESTILIZADOS */
        .input-luxe { 
            background: rgba(255, 255, 255, 0.02); 
            border: 1px solid rgba(255, 215, 0, 0.1); 
            color: #FFD700; 
            transition: 0.3s; 
            font-family: 'Cinzel', serif;
        }
        .input-luxe:focus { 
            outline: none; 
            border-color: #FFD700; 
            background: rgba(255, 215, 0, 0.05); 
            box-shadow: 0 0 15px rgba(184, 134, 11, 0.2);
        }
        .input-luxe::placeholder { color: #555; font-family: 'Lato', sans-serif; }

        /* PARTICLES (BRASAS SUBINDO) */
        .particle-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; overflow: hidden; }
        .particle {
            position: absolute; opacity: 0;
            animation: fireRise linear infinite;
            filter: blur(1px);
        }
        @keyframes fireRise {
            0% { opacity: 0; transform: translateY(100vh) scale(0.5); }
            20% { opacity: 0.6; }
            80% { opacity: 0.6; }
            100% { opacity: 0; transform: translateY(-10vh) scale(1.5); }
        }

        /* CARD DE V√çDEO / SE√á√ÉO */
        .project-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; overflow: hidden;
            background: linear-gradient(180deg, #0a0a0a 0%, #050505 100%);
        }
        .project-card:hover {
            transform: translateY(-5px);
            border-color: #FFD700;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 1), 0 0 20px rgba(255, 215, 0, 0.1);
        }
        .project-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 1px;
            background: linear-gradient(90deg, transparent, #FFD700, transparent);
            opacity: 0.3;
        }

        /* INTRO CINEMATOGR√ÅFICA */
        #intro-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; z-index: 100; 
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            transition: opacity 2s ease-out;
        }
        .intro-logo {
            width: 250px; 
            height: auto; 
            object-fit: contain;
            animation: pulseIntro 3s infinite alternate;
        }
        @media (max-width: 640px) {
            .intro-logo { width: 180px; }
        }
        @keyframes pulseIntro {
            0% { transform: scale(1); filter: drop-shadow(0 0 10px rgba(184, 134, 11, 0.1)); }
            100% { transform: scale(1.02); filter: drop-shadow(0 0 30px rgba(184, 134, 11, 0.4)); }
        }

        /* TRILHA (PATH SYSTEM) */
        .path-container-wrapper {
            position: relative; width: 100%; overflow-x: hidden; min-height: 600px;
            display: flex; justify-content: center; padding-top: 40px; padding-bottom: 100px;
        }
        .path-svg-line { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
        .path-node-wrapper { position: absolute; transform: translate(-50%, -50%); z-index: 2; display: flex; flex-direction: column; align-items: center; }
        
        .game-node {
            width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; cursor: pointer; position: relative; transition: transform 0.3s;
            box-shadow: 0 0 15px rgba(0,0,0,0.8); border: 2px solid #333;
            background: #000;
        }
        .game-node:active { transform: scale(0.95); }

        .game-node.status-completed {
            background: radial-gradient(circle, #B8860B, #3D3008);
            border: 2px solid #FFD700; color: #000; 
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.4);
        }
        .game-node.status-active {
            background: #8B0000; border: 2px solid #ff4444; color: #fff;
            box-shadow: 0 0 30px rgba(139, 0, 0, 0.6); animation: pulseActive 2s infinite;
        }
        @keyframes pulseActive {
            0% { box-shadow: 0 0 0 0 rgba(139, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(139, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(139, 0, 0, 0); }
        }
        .game-node.status-locked {
            background: #050505; border: 2px solid #222; color: #333; cursor: not-allowed;
        }
        
        .game-node.status-time-locked {
            background: #0a0000; border: 2px dashed #500; color: #500; cursor: not-allowed; opacity: 0.7;
        }

        .node-label {
            position: absolute; top: 85px; background: #111; color: #FFD700; padding: 5px 12px; border: 1px solid #333;
            font-family: 'Cinzel', serif; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.9); opacity: 0; transform: translateY(-10px); transition: 0.3s; pointer-events: none;
            text-align: center; min-width: 140px; left: 50%; transform: translateX(-50%); z-index: 10;
        }
        .path-node-wrapper:hover .node-label { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        .locked-tooltip {
            position: absolute; bottom: 85px; background: #2a0000; color: #ff8888; padding: 8px 12px; border: 1px solid #800;
            font-size: 0.6rem; text-transform: uppercase; letter-spacing: 1px; text-align: center;
            width: 160px; pointer-events: none; opacity: 0; transition: 0.3s; left: 50%; transform: translateX(-50%);
            z-index: 20; box-shadow: 0 0 20px rgba(0,0,0,1);
        }
        .path-node-wrapper:hover .game-node.status-time-locked ~ .locked-tooltip { opacity: 1; }

        .video-wrapper {
            position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;
            background: #000; border: 1px solid #333; box-shadow: 0 0 50px rgba(0,0,0,1);
        }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* Floating WhatsApp Button */
        .float-wa {
            position: fixed; width: 60px; height: 60px; bottom: 20px; right: 20px;
            background-color: #25d366; color: #FFF; border-radius: 50px; text-align: center; font-size: 30px;
            box-shadow: 0px 0px 20px rgba(37, 211, 102, 0.4); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s;
        }
        .float-wa:hover { transform: scale(1.1); box-shadow: 0px 0px 30px rgba(37, 211, 102, 0.6); }
        @media (min-width: 768px) {
            .float-wa { width: 60px; height: 60px; bottom: 40px; right: 40px; font-size: 30px; }
        }

    </style>
</head>
<body class="antialiased font-body selection:bg-primary-900 selection:text-white">

    <!-- INTRO DRAM√ÅTICA -->
    <div id="intro-overlay">
        <img src="https://i.ibb.co/BHPNVHbs/Whats-App-Image-2026-01-12-at-20-29-57.jpg" alt="Ordo Rex Lucifer Logo" class="intro-logo mb-8">
        <h1 class="text-xl md:text-3xl font-display text-white tracking-[0.3em] md:tracking-[0.5em] uppercase opacity-0 animate-fade-in-slow text-center px-4" style="animation-delay: 0.5s;">Ordo Rex Luciferi</h1>
        <p class="text-primary-500 text-[10px] md:text-xs tracking-[0.2em] md:tracking-[0.3em] uppercase mt-4 opacity-0 animate-fade-in-slow" style="animation-delay: 1.5s;">O Conhecimento √© Poder</p>
    </div>

    <!-- WhatsApp Button -->
    <a href="https://wa.me/5521975685161" class="float-wa" target="_blank" title="Fale com o Sacerdote">
        <i class="fab fa-whatsapp"></i>
    </a>

    <div class="particle-container" id="particles"></div>
    <script>
        const root = document.documentElement;
        root.style.setProperty('--primary-main', activeTheme.primary[400]);
        root.style.setProperty('--primary-light', activeTheme.primary[500]);
        root.style.setProperty('--accent-color', activeTheme.accent);

        const pContainer = document.getElementById('particles');
        for (let i = 0; i < 40; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.innerHTML = Math.random() > 0.5 ? '‚ú¶' : 'üî•';
            p.style.left = Math.random() * 100 + '%';
            p.style.animationDuration = Math.random() * 5 + 3 + 's';
            p.style.animationDelay = Math.random() * 5 + 's';
            p.style.fontSize = Math.random() * 10 + 5 + 'px';
            p.style.color = Math.random() > 0.7 ? '#FFD700' : '#8B0000';
            pContainer.appendChild(p);
        }

        // Remove Intro
        window.addEventListener('load', () => {
            setTimeout(() => {
                const intro = document.getElementById('intro-overlay');
                intro.style.opacity = '0';
                setTimeout(() => intro.style.display = 'none', 2000);
            }, 3500); // Tempo da intro
        });
    </script>

    <div id="app-root">
        
        <div id="loading-spinner" class="fixed inset-0 bg-black z-50 flex flex-col items-center justify-center hidden">
            <div class="relative mb-6">
                <i class="fas fa-crown text-5xl text-primary-500 animate-pulse"></i>
            </div>
            <p class="text-primary-400 text-xs tracking-[0.5em] uppercase font-display">Invocando a Luz...</p>
        </div>

        <!-- HEADER -->
        <header class="fixed top-0 w-full z-40 bg-black/90 backdrop-blur-md border-b border-primary-500/10 h-16 md:h-24 transition-all duration-300">
            <div class="container mx-auto px-4 md:px-6 h-full flex justify-between items-center">
                <div class="flex items-center gap-3 cursor-pointer group" onclick="showView('home-view')">
                    <!-- LOGO DA ORDEM NO HEADER -->
                    <img src="https://i.ibb.co/BHPNVHbs/Whats-App-Image-2026-01-12-at-20-29-57.jpg" alt="Logo" class="h-10 w-10 md:h-14 md:w-14 rounded-full border border-primary-500/30 group-hover:border-primary-400 transition shadow-[0_0_15px_rgba(184,134,11,0.2)] object-cover">
                    <div class="flex flex-col">
                        <span class="text-[8px] md:text-[9px] text-accent uppercase tracking-[0.4em] font-bold hidden md:block">Ordo</span>
                        <h1 class="text-sm md:text-xl font-display font-bold text-white tracking-widest group-hover:text-primary-400 transition">REX LUCIFERI</h1>
                    </div>
                </div>

                <!-- MENU DESKTOP -->
                <nav class="hidden md:flex items-center space-x-10">
                    <button data-view="home-view" class="internal-link text-[10px] font-display font-bold tracking-[0.2em] text-gray-500 hover:text-primary-400 uppercase transition">Templo</button>
                    <button data-view="blog-view" class="internal-link text-[10px] font-display font-bold tracking-[0.2em] text-gray-500 hover:text-primary-400 uppercase transition">Arquivos da Chama</button>
                    <a href="https://wa.me/5521975685161" target="_blank" class="text-[10px] font-display font-bold tracking-[0.2em] text-gray-500 hover:text-green-400 uppercase transition"><i class="fab fa-whatsapp mr-1"></i> Contato</a>
                    
                    <div class="w-[1px] h-6 bg-primary-500/20"></div>
                    
                    <div id="user-info" class="hidden items-center gap-4">
                        <button onclick="showView('profile-view')" class="flex items-center gap-3 text-gray-400 hover:text-primary-400 transition group">
                            <i id="header-user-icon" class="fas fa-user-astronaut"></i>
                            <div class="flex flex-col text-right">
                                <span class="text-[9px] text-accent uppercase tracking-widest">Iniciado</span>
                                <span id="header-user-name" class="text-[10px] hidden sm:inline uppercase font-display tracking-widest text-white group-hover:text-primary-400"></span>
                            </div>
                        </button>
                        <button id="logout-btn" class="text-gray-600 hover:text-red-600 text-xs transition" title="Sair"><i class="fas fa-sign-out-alt"></i></button>
                    </div>
                    <button id="login-btn" class="hidden px-6 py-2 border border-primary-500/30 text-[10px] font-display font-bold text-primary-400 uppercase tracking-widest hover:bg-primary-900/20 hover:border-primary-400 transition">Acesso</button>
                </nav>

                <!-- MOBILE MENU BUTTON -->
                <button id="mobile-menu-btn" class="md:hidden text-white text-xl">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            
            <!-- MOBILE MENU OVERLAY -->
            <div id="mobile-menu" class="hidden absolute top-16 left-0 w-full bg-black/95 border-b border-primary-500/20 p-6 flex-col gap-4 text-center z-50">
                <button data-view="home-view" class="internal-link text-xs font-display font-bold tracking-[0.2em] text-white py-2 uppercase">Templo</button>
                <button data-view="blog-view" class="internal-link text-xs font-display font-bold tracking-[0.2em] text-white py-2 uppercase">Arquivos</button>
                <a href="https://wa.me/5521975685161" target="_blank" class="text-xs font-display font-bold tracking-[0.2em] text-white py-2 uppercase hover:text-green-400"><i class="fab fa-whatsapp mr-1"></i> Contato</a>
                
                <div id="mobile-user-actions" class="border-t border-white/10 pt-4 mt-2 flex flex-col gap-3">
                    <!-- Injected via JS -->
                </div>
            </div>
        </header>

        <main class="pt-16 md:pt-24 min-h-screen relative z-10">
            
            <!-- HOME VIEW -->
            <div id="home-view" class="view-container">
                <!-- HERO SECTION -->
                <section class="relative min-h-[90vh] flex flex-col items-center justify-center text-center px-4 overflow-hidden">
                    <!-- Fundo Sombrio com Brilho Central -->
                    <div class="absolute inset-0 z-0 bg-[radial-gradient(circle_at_center,rgba(184,134,11,0.15)_0%,rgba(0,0,0,1)_70%)]"></div>
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[300px] h-[300px] md:w-[800px] md:h-[800px] border border-primary-500/5 rounded-full animate-pulse-slow pointer-events-none"></div>
                    
                    <div class="relative z-10 max-w-5xl mx-auto space-y-6 md:space-y-8">
                        <div class="flex justify-center mb-4 md:mb-6">
                            <i class="fas fa-fire text-2xl md:text-3xl text-accent animate-pulse"></i>
                        </div>
                        
                        <h2 class="text-primary-500 text-[10px] md:text-sm tracking-[0.5em] md:tracking-[0.8em] uppercase fade-in-up font-display border-b border-primary-500/20 pb-4 inline-block">
                            Lux Ex Tenebris
                        </h2>
                        
                        <h1 class="text-3xl md:text-5xl lg:text-8xl font-display font-black text-white leading-tight fade-in-up uppercase" style="animation-delay: 0.2s">
                            Desperte a <br><span class="text-gradient-gold">Divindade</span> Interior
                        </h1>
                        
                        <p class="text-gray-400 max-w-2xl mx-auto text-sm md:text-lg font-body font-light leading-relaxed fade-in-up px-4" style="animation-delay: 0.4s">
                            Bem-vindo √† <strong>Ordo Rex i</strong>. Aqui, a escurid√£o n√£o √© o fim, mas o √∫tero onde a verdadeira luz √© forjada pela vontade indom√°vel.
                        </p>
                        
                        <div class="pt-8 md:pt-10 fade-in-up flex justify-center gap-6" style="animation-delay: 0.6s">
                            <button data-view="blog-view" class="internal-link px-8 md:px-12 py-3 md:py-4 bg-primary-900/20 border border-primary-500 text-primary-400 font-display text-[10px] md:text-xs font-bold tracking-[0.3em] uppercase hover:bg-primary-500 hover:text-black transition shadow-[0_0_30px_rgba(184,134,11,0.1)] relative group overflow-hidden">
                                <span class="relative z-10">Iniciar a Jornada</span>
                                <div class="absolute inset-0 bg-primary-500 opacity-0 group-hover:opacity-100 transition duration-500"></div>
                            </button>
                        </div>
                    </div>
                </section>

                <!-- FILOSOFIA & O DRAG√ÉO (EXTENSA) -->
                <section class="py-20 md:py-32 px-6 bg-obsidian border-t border-primary-900/20 relative overflow-hidden">
                    <!-- Fundo do Drag√£o -->
                    <div class="absolute inset-0 z-0">
                        <img src="https://i.ibb.co/q4DcCM6/33333333.jpg" alt="Drag√£o Primordial" class="w-full h-full object-cover opacity-20 object-center">
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/80 to-transparent"></div>
                    </div>

                    <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-12 md:gap-20 items-center relative z-10">
                        <div class="order-2 md:order-1 space-y-8 md:space-y-10 text-justify">
                            <div>
                                <h3 class="text-2xl md:text-4xl font-display text-white mb-2 flex items-center gap-4">
                                    <span class="text-primary-500 text-4xl md:text-6xl opacity-50">I.</span> A Doutrina do Drag√£o
                                </h3>
                                <div class="h-[1px] w-24 bg-accent mt-4"></div>
                            </div>
                            
                            <p class="text-gray-300 font-body leading-loose text-sm md:text-lg drop-shadow-lg">
                                O Drag√£o √© o s√≠mbolo m√°ximo da energia primordial e indomada. Na <strong>Ordo Rex Luciferi</strong>, ele representa a for√ßa latente que reside na base da espinha de cada iniciado, pronta para despertar e ascender aos c√©us da consci√™ncia.
                            </p>
                            
                            <p class="text-gray-300 font-body leading-loose text-sm md:text-lg drop-shadow-lg">
                                N√£o tememos a besta interior; n√≥s a montamos. O Drag√£o √© a soberania sobre os instintos, transformando o caos bruto em poder focado e vontade direcionada. Quem domina o Drag√£o, domina a si mesmo.
                            </p>

                            <div class="bg-black/70 border-l-2 border-primary-500 p-6 backdrop-blur-sm">
                                <p class="text-primary-400 font-display italic text-sm md:text-lg mb-2">"Do abismo primordial, o Drag√£o se ergue, n√£o para destruir o mundo, mas para iluminar a mente daqueles que ousam olhar em seus olhos."</p>
                                <p class="text-gray-500 text-[10px] md:text-xs uppercase tracking-widest">‚Äî Codex Draconis</p>
                            </div>
                        </div>

                        <!-- Imagem Lateral (Luciferiana) -->
                        <div class="order-1 md:order-2 flex justify-center relative h-[400px] md:h-[600px] items-center group">
                             <div class="absolute inset-0 bg-gradient-to-br from-primary-500/10 to-accent/10 blur-[50px] rounded-full pointer-events-none animate-pulse"></div>
                             
                             <div class="relative w-full h-full border border-primary-500/20 p-2 bg-black/50 backdrop-blur-sm transform group-hover:scale-[1.02] transition duration-700">
                                 <img src="https://i.ibb.co/21p54bPq/22222222.jpg" alt="O Portador da Luz" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition duration-700 grayscale group-hover:grayscale-0">
                                 <div class="absolute bottom-0 left-0 w-full p-6 bg-gradient-to-t from-black to-transparent">
                                     <span class="text-primary-500 text-[10px] md:text-xs uppercase tracking-[0.3em] font-bold">Lucifer</span>
                                     <h4 class="text-white font-display text-xl md:text-2xl uppercase">O Arqu√©tipo da Liberdade</h4>
                                 </div>
                             </div>
                        </div>
                    </div>
                </section>

                <!-- PILARES DA ORDEM (GRID - REFEITO COM SVGs ANIMADOS) -->
                <section class="py-20 md:py-24 px-6 bg-void relative overflow-hidden">
                    <div class="absolute top-0 w-full h-[1px] bg-gradient-to-r from-transparent via-primary-500/30 to-transparent"></div>
                    <div class="max-w-7xl mx-auto">
                        <div class="text-center mb-12 md:mb-16 space-y-4">
                            <i class="fas fa-chess-king text-primary-500 text-3xl opacity-80"></i>
                            <h3 class="text-2xl md:text-4xl font-display text-white uppercase tracking-widest">Os Pilares da Ascens√£o</h3>
                            <p class="text-gray-500 text-[10px] md:text-xs uppercase tracking-[0.3em]">As bases do nosso Templo</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <!-- Card 1 (Gnose) -->
                            <div class="project-card border border-white/5 p-0 relative group cursor-pointer h-full bg-black" onclick="showView('blog-view')">
                                <div class="h-40 md:h-48 overflow-hidden relative flex items-center justify-center bg-royal group-hover:bg-primary-900/20 transition duration-700">
                                    <!-- SVG Gnose Animado -->
                                    <svg class="w-20 h-20 md:w-24 md:h-24 text-primary-500 animate-float" viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M50 10 L90 50 L50 90 L10 50 Z" class="opacity-50" />
                                        <circle cx="50" cy="50" r="15" />
                                        <path d="M50 35 L50 65 M35 50 L65 50" />
                                    </svg>
                                    <div class="absolute inset-0 bg-gradient-to-t from-black to-transparent"></div>
                                </div>
                                <div class="p-6 md:p-8 relative">
                                    <div class="absolute -top-10 right-6 bg-black border border-primary-500 p-3 rounded-full">
                                        <i class="fas fa-book-dead text-2xl text-primary-500"></i>
                                    </div>
                                    <h4 class="text-xl md:text-2xl font-display text-primary-400 mb-4 group-hover:text-white transition uppercase">Gnose <span class="text-[10px] block text-gray-600 tracking-widest mt-1">Conhecimento</span></h4>
                                    <p class="text-gray-400 text-xs md:text-sm leading-relaxed mb-6 min-h-[60px]">
                                        Estudo profundo de magia cerimonial, psicologia sombria e filosofia ocultista. O saber √© a √∫nica arma que n√£o enferruja.
                                    </p>
                                    <span class="text-[10px] font-bold text-accent uppercase tracking-widest group-hover:text-white transition flex items-center gap-2">Explorar Arquivos <i class="fas fa-arrow-right"></i></span>
                                </div>
                            </div>

                            <!-- Card 2 (Potentia) -->
                            <div class="project-card border border-white/5 p-0 relative group cursor-pointer h-full bg-black">
                                <div class="h-40 md:h-48 overflow-hidden relative flex items-center justify-center bg-royal group-hover:bg-accent/20 transition duration-700">
                                    <!-- SVG Potentia Animado -->
                                    <svg class="w-20 h-20 md:w-24 md:h-24 text-accent animate-pulse-slow" viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M50 15 Q80 15 80 50 Q80 85 50 85 Q20 85 20 50 Q20 15 50 15 Z" />
                                        <path d="M50 25 L55 45 L75 50 L55 55 L50 75 L45 55 L25 50 L45 45 Z" fill="currentColor" opacity="0.5"/>
                                    </svg>
                                    <div class="absolute inset-0 bg-gradient-to-t from-black to-transparent"></div>
                                </div>
                                <div class="p-6 md:p-8 relative">
                                    <div class="absolute -top-10 right-6 bg-black border border-accent p-3 rounded-full">
                                        <i class="fas fa-fist-raised text-2xl text-accent"></i>
                                    </div>
                                    <h4 class="text-xl md:text-2xl font-display text-primary-400 mb-4 group-hover:text-white transition uppercase">Potentia <span class="text-[10px] block text-gray-600 tracking-widest mt-1">Poder Pessoal</span></h4>
                                    <p class="text-gray-400 text-xs md:text-sm leading-relaxed mb-6 min-h-[60px]">
                                        Pr√°ticas para fortalecer a Vontade. Rituais de empoderamento e a arte de moldar a realidade conforme o desejo do Magista.
                                    </p>
                                    <span class="text-[10px] font-bold text-accent uppercase tracking-widest group-hover:text-white transition flex items-center gap-2">Ver Rituais <i class="fas fa-fire"></i></span>
                                </div>
                            </div>

                            <!-- Card 3 (Fraternitas) -->
                            <div class="project-card border border-white/5 p-0 relative group cursor-pointer h-full bg-black">
                                <div class="h-40 md:h-48 overflow-hidden relative flex items-center justify-center bg-royal group-hover:bg-white/5 transition duration-700">
                                    <!-- SVG Fraternitas Animado -->
                                    <svg class="w-20 h-20 md:w-24 md:h-24 text-gray-400 animate-spin-slow" viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <circle cx="50" cy="50" r="30" stroke-dasharray="5,5" />
                                        <circle cx="50" cy="50" r="10" />
                                        <path d="M50 20 L50 80 M20 50 L80 50" />
                                    </svg>
                                    <div class="absolute inset-0 bg-gradient-to-t from-black to-transparent"></div>
                                </div>
                                <div class="p-6 md:p-8 relative">
                                    <div class="absolute -top-10 right-6 bg-black border border-white/20 p-3 rounded-full">
                                        <i class="fas fa-crown text-2xl text-white"></i>
                                    </div>
                                    <h4 class="text-xl md:text-2xl font-display text-primary-400 mb-4 group-hover:text-white transition uppercase">Fraternitas <span class="text-[10px] block text-gray-600 tracking-widest mt-1">O C√≠rculo Interno</span></h4>
                                    <p class="text-gray-400 text-xs md:text-sm leading-relaxed mb-6 min-h-[60px]">
                                        Uma comunidade seleta de iniciados. Aqui, a lealdade e a troca de experi√™ncias elevam todos os membros.
                                    </p>
                                    <span class="text-[10px] font-bold text-accent uppercase tracking-widest group-hover:text-white transition flex items-center gap-2">Unir-se √† Ordem <i class="fas fa-user-plus"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- CALL TO ACTION FINAL -->
                <section class="py-20 md:py-28 px-6 border-t border-primary-900/30 bg-[#020202] text-center relative overflow-hidden">
                     <div class="absolute inset-0 bg-gradient-to-t from-accent/5 to-transparent blur-[100px] pointer-events-none"></div>
                    <div class="max-w-3xl mx-auto space-y-8 md:space-y-10 relative z-10">
                        <div class="mb-4">
                            <i class="fas fa-skull text-3xl md:text-4xl text-accent animate-pulse"></i>
                        </div>
                        <h3 class="text-3xl md:text-5xl font-display text-white uppercase leading-tight">
                            O Chamado do Abismo
                        </h3>
                        <p class="text-gray-400 font-body leading-loose text-sm md:text-lg">
                            Muitos ouvem o sussurro, poucos t√™m a coragem de responder. <br>
                            Se voc√™ sente a Chama Negra queimar em seu peito, seu lugar √© entre os Reis e Rainhas desta era.
                        </p>
                        <div class="pt-6">
                            <button onclick="document.getElementById('login-view').style.display='flex'" class="inline-block border border-primary-500 px-12 py-5 text-primary-400 font-display text-xs font-bold tracking-[0.4em] uppercase hover:bg-primary-900 hover:text-white hover:border-primary-900 transition duration-500 shadow-[0_0_20px_rgba(184,134,11,0.2)]">
                                Requerer Inicia√ß√£o
                            </button>
                        </div>
                        <p class="text-[8px] md:text-[9px] text-gray-600 uppercase tracking-widest mt-8">A porta est√° aberta, mas o caminho √© estreito.</p>
                    </div>
                </section>
            </div>

            <!-- ACERVO / BLOG VIEW -->
            <div id="blog-view" class="view-container hidden max-w-7xl mx-auto pt-10 px-4">
                
                <!-- PAINEL ADMIN -->
                <div id="admin-panel" class="hidden mb-16 p-4 md:p-8 bg-royal border border-primary-500/20 rounded-none relative overflow-hidden shadow-[0_0_50px_rgba(0,0,0,0.5)]">
                    <div class="absolute top-0 w-full h-1 bg-gradient-to-r from-transparent via-primary-500 to-transparent"></div>
                    
                    <div class="flex justify-between items-center mb-8 relative z-10">
                        <h3 class="text-primary-400 font-display text-xl md:text-2xl flex items-center gap-3"><i class="fas fa-chess-king"></i> Painel do Magister Templi</h3>
                        <button onclick="showView('students-view')" class="bg-primary-900 border border-primary-500/50 text-white px-6 py-3 font-display font-bold uppercase tracking-[0.2em] text-xs hover:bg-primary-500 hover:text-black transition shadow-[0_0_15px_rgba(184,134,11,0.3)]">
                            <i class="fas fa-users mr-2"></i> Gerenciar Iniciados
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 md:gap-12 relative z-10">
                        <form id="create-post-form" class="lg:col-span-1 space-y-6">
                            <h4 class="text-gray-500 text-xs uppercase tracking-[0.2em] border-b border-white/5 pb-2">Novo Rito de Conhecimento</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 lg:grid-cols-1">
                                <input type="text" id="post-title" class="input-luxe w-full p-4 text-sm md:text-lg" placeholder="Nome do Ritual (T√≠tulo)" required>
                                <input type="text" id="post-subtitle" class="input-luxe w-full p-4 text-xs md:text-sm" placeholder="Arcano (Subt√≠tulo)" required>
                            </div>
                            
                            <div class="p-4 md:p-6 bg-black border border-white/5 space-y-4">
                                <p class="text-[10px] text-accent uppercase tracking-widest font-bold"><i class="fab fa-google-drive mr-2"></i>Chaves do Drive</p>
                                <input type="url" id="post-video-link" class="input-luxe w-full p-3 text-sm" placeholder="Link do V√çDEO (Google Drive)" required>
                                <input type="url" id="post-pdf-link" class="input-luxe w-full p-3 text-sm" placeholder="Link do PDF (Google Drive)" required>
                            </div>

                            <textarea id="post-content" rows="3" class="input-luxe w-full p-4 text-sm font-body" placeholder="Palavras de introdu√ß√£o..."></textarea>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 lg:grid-cols-1">
                                <select id="post-access" class="input-luxe w-full p-3 bg-black cursor-pointer text-xs uppercase"><option value="aberto">üëÅÔ∏è Exot√©rico (Aberto)</option><option value="pago">üóùÔ∏è Esot√©rico (Fechado)</option></select>
                                <select id="post-section" class="input-luxe w-full p-3 bg-black cursor-pointer text-xs uppercase" required><option value="">Carregando Caminhos...</option></select>
                            </div>

                            <button type="submit" class="w-full bg-primary-900/20 border border-primary-500 text-primary-400 py-4 font-display font-bold uppercase text-xs tracking-[0.3em] hover:bg-primary-500 hover:text-black transition">Consagrar Aula</button>
                            <p id="post-status" class="text-center text-xs h-4 text-primary-500 font-display"></p>
                        </form>

                        <!-- Gest√£o de M√≥dulos (Coluna 2) -->
                        <div class="lg:col-span-1 bg-black/40 p-4 md:p-6 border border-white/5 flex flex-col">
                            <h4 class="text-gray-400 text-xs uppercase tracking-widest mb-4 flex justify-between items-center">
                                <span><i class="fas fa-map-signs mr-2"></i>Gerenciador de Se√ß√µes</span>
                                <span id="section-count" class="bg-primary-900/30 text-primary-400 px-2 py-1 text-[10px] rounded">0 Trilhas</span>
                            </h4>
                            
                            <form id="create-section-form" class="flex gap-2 mb-4 shrink-0">
                                <input type="text" id="section-name" placeholder="Nome da Nova Trilha" class="input-luxe w-full p-2 text-xs">
                                <button type="submit" class="bg-primary-900/30 border border-primary-500/30 text-primary-400 hover:bg-primary-500 hover:text-black px-4 transition"><i class="fas fa-plus"></i></button>
                            </form>
                            
                            <div id="sections-list-admin" class="flex-1 overflow-y-auto custom-scrollbar space-y-2 pr-2">
                                <!-- Sections injected here -->
                            </div>
                        </div>

                        <!-- Editor de Privacidade de M√≥dulos (Coluna 3) -->
                        <div class="lg:col-span-1 bg-black/40 p-4 md:p-6 border border-accent/20 flex flex-col">
                            <h4 class="text-accent text-xs uppercase tracking-widest mb-4 flex items-center">
                                <i class="fas fa-shield-alt mr-2"></i> Editor de Acesso
                            </h4>
                            
                            <div id="sections-privacy-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-2 pr-2">
                                <!-- Privacy toggles injected here -->
                            </div>
                            
                            <p class="text-[9px] text-gray-600 mt-4 italic border-t border-white/5 pt-4">
                                <i class="fas fa-eye mr-1"></i> P√∫blico: Vis√≠vel para alunos com acesso
                                <br><i class="fas fa-lock mr-1"></i> Privado: Bloqueado at√© libera√ß√£o
                            </p>
                        </div>
                    </div>

                    <!-- SE√á√ÉO DE PRIVACIDADE DE AULAS -->
                    <div class="mt-12 pt-8 border-t border-white/10">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 md:gap-12">
                            <!-- Seletor de M√≥dulo para Gerenciar Aulas -->
                            <div class="bg-black/40 p-4 md:p-6 border border-primary-500/20 flex flex-col">
                                <h4 class="text-primary-400 text-xs uppercase tracking-widest mb-4 flex items-center">
                                    <i class="fas fa-book-open mr-2"></i> Selecionar Trilha
                                </h4>
                                <select id="admin-posts-section-select" class="input-luxe w-full p-3 bg-black cursor-pointer text-xs uppercase mb-4">
                                    <option value="">Escolha uma trilha...</option>
                                </select>
                                <p class="text-[9px] text-gray-600 mt-auto">Selecione uma trilha para gerenciar a privacidade de suas aulas.</p>
                            </div>

                            <!-- Lista de Aulas e seus Status de Privacidade -->
                            <div class="lg:col-span-2 bg-black/40 p-4 md:p-6 border border-accent/20 flex flex-col">
                                <h4 class="text-accent text-xs uppercase tracking-widest mb-4 flex items-center">
                                    <i class="fas fa-lock-open mr-2"></i> Privacidade das Aulas
                                </h4>
                                
                                <div id="posts-privacy-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-2 pr-2">
                                    <p class="text-gray-600 text-xs italic text-center py-6">Selecione uma trilha acima para ver as aulas.</p>
                                </div>
                                
                                <p class="text-[9px] text-gray-600 mt-4 italic border-t border-white/5 pt-4">
                                    <i class="fas fa-eye mr-1"></i> P√∫blico: Vis√≠vel mesmo deslogado
                                    <br><i class="fas fa-lock mr-1"></i> Privado: Apenas alunos logados
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- HUB DE SE√á√ïES -->
                <div id="sections-hub" class="mb-20">
                    <div class="text-center mb-16 space-y-6">
                        <i class="fas fa-dungeon text-primary-500 text-4xl opacity-80"></i>
                        <h3 class="text-3xl md:text-5xl font-display text-white uppercase">Arquivos da Chama</h3>
                        <div class="h-[1px] w-24 bg-gradient-to-r from-transparent via-accent to-transparent mx-auto"></div>
                        <p class="text-gray-500 text-xs uppercase tracking-[0.3em]">Escolha o portal que deseja atravessar</p>
                    </div>
                    <div id="sections-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">
                        <div class="col-span-full text-center py-20">
                            <i class="fas fa-circle-notch fa-spin text-primary-900 text-4xl"></i>
                        </div>
                    </div>
                </div>

                <!-- TRILHA / PATH VIEW -->
                <div id="active-path-view" class="hidden mb-20 relative">
                    <button id="back-to-hub-btn" class="fixed top-20 md:top-28 left-4 md:left-6 z-30 text-primary-500/70 hover:text-primary-400 text-[10px] uppercase tracking-[0.2em] flex items-center gap-3 transition bg-black/80 p-3 border border-primary-500/20 hover:border-primary-500 font-display">
                        <i class="fas fa-chevron-left"></i> Voltar aos Portais
                    </button>

                    <div class="text-center mb-20 pt-12 md:pt-8 relative z-10">
                        <!-- STATUS DO CICLO SEMANAL -->
                        <div id="weekly-status-container" class="max-w-md mx-auto mb-8 p-4 border border-white/10 bg-white/5 text-center hidden">
                            <!-- Injected via JS -->
                        </div>

                        <h2 id="path-title" class="text-3xl md:text-4xl font-display text-white mb-4 uppercase text-gradient-gold"></h2>
                        <span class="text-gray-600 text-[10px] uppercase tracking-[0.5em] border-t border-b border-gray-800 py-2">Trilha de Ascens√£o</span>
                    </div>

                    <div class="relative w-full md:max-w-4xl max-w-md mx-auto min-h-[600px] px-4 pb-20">
                        <!-- Fundo da Trilha -->
                        <div class="absolute inset-0 bg-gradient-to-b from-primary-900/5 via-transparent to-transparent pointer-events-none"></div>
                        <div id="path-steps-container" class="path-container-wrapper"></div>
                        <p id="empty-path-msg" class="hidden text-center text-gray-600 text-sm italic mt-10 font-display">O caminho ainda n√£o foi revelado.</p>
                    </div>
                </div>
            </div>

            <!-- NOVA VIEW: GERENCIAMENTO DE INICIADOS -->
            <div id="students-view" class="view-container hidden max-w-7xl mx-auto pt-10 px-4">
                <div class="mb-8 flex flex-col md:flex-row justify-between items-center gap-6">
                    <div>
                        <button onclick="showView('blog-view')" class="text-gray-500 hover:text-white uppercase text-xs tracking-widest mb-4 block"><i class="fas fa-arrow-left mr-2"></i> Voltar ao Painel</button>
                        <h2 class="text-3xl font-display text-white uppercase"><i class="fas fa-users-cog text-primary-500 mr-3"></i>Gest√£o de Iniciados</h2>
                        <p class="text-gray-500 text-xs uppercase tracking-widest mt-2">Controle Supremo de Acesso e Tempo</p>
                    </div>
                    
                    <div class="bg-royal border border-primary-500/20 p-6 shadow-2xl w-full md:w-auto">
                        <h4 class="text-primary-400 text-xs uppercase tracking-widest mb-4 font-bold border-b border-white/5 pb-2">Novo Iniciado</h4>
                        <form id="create-account-form" class="flex flex-col gap-3">
                            <input type="email" id="new-email" placeholder="Email do Ne√≥fito" class="input-luxe p-3 text-xs" required>
                            <input type="password" id="new-password" placeholder="Senha de Acesso" class="input-luxe p-3 text-xs" required>
                            <button type="submit" id="create-student-btn" class="bg-primary-900 hover:bg-primary-500 text-white hover:text-black py-2 text-[10px] uppercase tracking-widest transition font-bold">Registrar (+30 dias)</button>
                            <p id="account-status" class="text-xs h-4 text-center"></p>
                        </form>
                    </div>
                </div>

                <!-- Tabela de Alunos -->
                <div class="bg-black/40 border border-white/5 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-white/5 border-b border-white/10 text-xs text-gray-400 uppercase tracking-widest">
                                    <th class="p-4 font-display font-normal">Iniciado (Email)</th>
                                    <th class="p-4 font-display font-normal">Status</th>
                                    <th class="p-4 font-display font-normal">Vencimento</th>
                                    <th class="p-4 font-display font-normal text-right">Rituais de Controle</th>
                                </tr>
                            </thead>
                            <tbody id="students-table-body" class="text-sm text-gray-300 divide-y divide-white/5">
                                <!-- Linhas injetadas via JS -->
                            </tbody>
                        </table>
                    </div>
                    <div id="students-loading" class="p-8 text-center text-gray-500 text-xs uppercase tracking-widest hidden">Carregando livro da vida...</div>
                    <div id="students-empty" class="p-8 text-center text-gray-500 text-xs uppercase tracking-widest hidden">Nenhum iniciado encontrado.</div>
                </div>
            </div>

            <!-- PERFIL -->
            <div id="profile-view" class="view-container hidden max-w-2xl mx-auto pt-10 px-4">
                 <div class="bg-royal border border-white/10 p-6 md:p-10 relative overflow-hidden shadow-2xl">
                     <i class="fas fa-id-card-alt text-6xl text-white/5 absolute top-5 right-5"></i>
                     <h2 class="text-2xl md:text-3xl font-display text-white mb-2">Credencial da Ordem</h2>
                     <div class="h-[1px] w-full bg-gradient-to-r from-transparent via-primary-500 to-transparent my-6 opacity-30"></div>
                     <p class="text-xs text-primary-500 uppercase tracking-widest mb-2">Identidade Espiritual</p>
                     <p id="profile-email-display" class="text-lg md:text-xl text-white font-display tracking-wider mb-6 break-words"></p>
                     <p id="profile-status-display" class="text-xs font-bold uppercase tracking-[0.2em] mb-4"></p>
                     
                     <p id="profile-admin-badge" class="hidden inline-block border border-accent/50 text-accent px-4 py-2 text-[10px] uppercase tracking-[0.2em] font-bold">
                        <i class="fas fa-crown mr-2"></i> Magister Templi
                     </p>
                     
                     <!-- NOVO: SELETOR DE AULA INICIAL -->
                     <div id="starting-lesson-container" class="hidden mt-8 p-4 bg-black/40 border border-primary-500/20 rounded">
                         <h4 class="text-primary-400 text-sm uppercase tracking-widest font-display mb-4 flex items-center">
                             <i class="fas fa-graduation-cap mr-2"></i> Ponto de Partida da Jornada
                         </h4>
                         <p class="text-gray-500 text-xs mb-4">Se iniciou avan√ßado, selecione at√© qual aula deseja come√ßar:</p>
                         
                         <div id="starting-lesson-select-wrapper" class="space-y-3 max-h-60 overflow-y-auto custom-scrollbar">
                             <!-- Seletor de aulas injetado aqui -->
                         </div>
                         
                         <button id="save-starting-lesson-btn" class="w-full mt-4 bg-primary-900/20 border border-primary-500 text-primary-400 hover:bg-primary-500 hover:text-black py-3 text-[10px] uppercase tracking-[0.3em] transition font-bold">
                             Confirmar Ponto de Partida
                         </button>
                         <p id="lesson-save-status" class="text-center text-xs mt-2 text-primary-500"></p>
                     </div>

                     <div class="mt-10 bg-black/50 p-4 border border-white/5">
                         <p class="text-[10px] text-gray-600 uppercase">Seu progresso √© registrado no livro da vida.</p>
                     </div>
                 </div>
            </div>

        </main>

        <!-- MODAL DE LOGIN -->
        <div id="login-view" class="view-container hidden fixed inset-0 z-50 bg-black/95 backdrop-blur-md flex items-center justify-center p-4">
            <div class="w-full max-w-md relative bg-royal p-8 md:p-12 border border-primary-500/20 shadow-[0_0_100px_rgba(0,0,0,1)]">
                <button id="close-login-btn" class="absolute top-4 right-4 text-gray-600 hover:text-white transition"><i class="fas fa-times"></i></button>
                
                <div class="text-center mb-12">
                    <img src="https://i.ibb.co/BHPNVHbs/Whats-App-Image-2026-01-12-at-20-29-57.jpg" alt="Logo" class="h-20 w-20 mx-auto rounded-full border border-primary-500/30 mb-4 object-cover">
                    <h2 id="login-title" class="text-3xl font-display text-white tracking-[0.2em] uppercase">Sanctum</h2>
                    <div class="h-[1px] w-12 bg-accent mx-auto my-4"></div>
                    <p id="login-subtitle" class="text-[10px] text-gray-500 uppercase tracking-[0.4em]">Identifique-se</p>
                </div>
                
                <form id="login-form" class="space-y-8">
                    <div class="group relative">
                        <input type="email" id="login-email" placeholder="EMAIL" class="w-full bg-transparent border-b border-gray-800 p-4 text-center text-white outline-none font-display tracking-widest focus:border-primary-500 transition-colors placeholder:text-gray-700">
                    </div>
                    <div class="group relative">
                        <input type="password" id="login-password" placeholder="SENHA" class="w-full bg-transparent border-b border-gray-800 p-4 text-center text-white outline-none font-display tracking-widest focus:border-primary-500 transition-colors placeholder:text-gray-700">
                    </div>
                    <button type="submit" id="login-submit-btn" class="w-full border border-primary-900 text-primary-400 py-5 uppercase text-[10px] tracking-[0.4em] hover:bg-primary-500 hover:text-black transition font-bold mt-4 shadow-[0_0_20px_rgba(0,0,0,0.5)]">Adentrar</button>
                </form>

                <div class="text-center mt-10 pt-8 border-t border-white/5">
                    <button id="toggle-register-btn" class="text-gray-600 text-[9px] uppercase tracking-[0.2em] hover:text-white transition">Solicitar Inicia√ß√£o (Criar Conta)</button>
                </div>

                <p id="login-error" class="text-center text-accent text-xs mt-6 font-display tracking-wider"></p>
            </div>
        </div>

        <!-- PLAYER DE V√çDEO (AULA) -->
        <div id="post-view" class="view-container hidden fixed inset-0 z-[60] bg-black overflow-y-auto custom-scrollbar">
            <div class="max-w-6xl mx-auto min-h-screen bg-royal border-x border-white/5 relative shadow-2xl">
                <!-- Top Bar -->
                <div class="sticky top-0 z-20 bg-royal/95 backdrop-blur border-b border-white/5 p-4 flex justify-between items-center h-16 md:h-20 shadow-lg px-4 md:px-8">
                    <button id="back-to-posts-btn" class="text-gray-400 text-[10px] uppercase tracking-[0.2em] hover:text-primary-400 transition flex items-center gap-3 group font-display">
                        <i class="fas fa-long-arrow-alt-left text-lg group-hover:-translate-x-1 transition"></i> Retornar
                    </button>
                    <div class="admin-only-controls hidden gap-4">
                        <button id="post-view-delete-btn" class="text-red-900 hover:text-red-500 transition text-xs uppercase tracking-widest border border-red-900/30 px-4 py-2 hover:bg-red-900/10"><i class="fas fa-trash mr-2"></i> Excluir Registro</button>
                    </div>
                </div>

                <div class="p-0">
                    <!-- √ÅREA DO V√çDEO -->
                    <div class="w-full bg-black border-b border-primary-500/20 relative">
                        <div class="absolute inset-0 bg-accent/5 pointer-events-none"></div>
                        <div class="max-w-5xl mx-auto video-wrapper">
                            <iframe id="video-iframe" src="" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>
                        </div>
                    </div>

                    <div class="p-6 md:p-16 pb-32">
                        <!-- T√çTULO E DOWNLOAD -->
                        <div class="flex flex-col md:flex-row justify-between items-start gap-8 md:gap-12 mb-8 md:mb-12 border-b border-white/5 pb-8 md:pb-12">
                            <div class="flex-1 space-y-4">
                                <span class="text-accent text-[9px] uppercase tracking-[0.4em] font-bold block border-l-2 border-accent pl-3">Rito em Andamento</span>
                                <h1 id="post-view-title" class="text-2xl md:text-5xl font-display text-white leading-tight uppercase"></h1>
                                <h3 id="post-view-subtitle" class="text-lg md:text-xl text-primary-500 font-display italic"></h3>
                            </div>
                            
                            <a id="post-view-pdf-btn" href="#" target="_blank" class="w-full md:w-auto shrink-0 bg-black border border-primary-900 hover:border-primary-500 text-gray-300 hover:text-white px-8 py-5 font-display font-bold uppercase tracking-[0.2em] text-[10px] flex items-center justify-center gap-4 transition group">
                                <i class="fas fa-scroll text-2xl text-primary-500 group-hover:text-white transition"></i> 
                                <div class="text-left">
                                    <span class="block text-[8px] text-gray-600">Documento Sagrado</span>
                                    <span>Baixar PDF</span>
                                </div>
                            </a>
                        </div>

                        <!-- DESCRI√á√ÉO -->
                        <div class="mb-16 grid grid-cols-1 lg:grid-cols-3 gap-12">
                            <div class="lg:col-span-2">
                                <h4 class="text-gray-600 text-[10px] uppercase tracking-[0.2em] mb-6"><i class="fas fa-align-left mr-2"></i>Escrituras do Mestre</h4>
                                <div id="post-view-content" class="prose prose-invert max-w-none text-gray-400 font-body leading-loose text-justify border-l border-white/5 pl-6 text-sm md:text-base"></div>
                            </div>
                            
                            <!-- BOT√ÉO CONCLUIR (LADO DIREITO) -->
                            <div class="flex flex-col items-center justify-center bg-black/30 p-8 border border-white/5 h-fit">
                                <i class="fas fa-certificate text-4xl text-gray-800 mb-6"></i>
                                <p class="text-center text-gray-500 text-xs mb-6">Ao finalizar o estudo, sele a sua mente.</p>
                                <button id="mark-complete-btn" class="w-full bg-transparent border border-primary-500/30 text-primary-400 hover:bg-primary-500 hover:text-black py-4 font-display font-bold uppercase tracking-[0.2em] text-[10px] transition transform hover:scale-105 flex items-center justify-center gap-3">
                                    <i class="fas fa-check-circle text-lg"></i> Consagrar Leitura
                                </button>
                            </div>
                        </div>
                        
                        <!-- COMENT√ÅRIOS -->
                        <div id="comments-section" class="border-t border-white/5 pt-12">
                             <h3 class="text-xl md:text-2xl font-display text-white mb-8"><i class="fas fa-comments text-primary-900 mr-3"></i> Di√°logo da Ordem</h3>
                             
                             <div id="comments-list" class="space-y-6 mb-10"></div>
                             
                             <div id="comment-form-container" class="hidden bg-black p-6 border border-white/10">
                                 <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-4">Sua voz no abismo</p>
                                 <textarea id="comment-input" class="input-luxe w-full p-4 text-sm mb-4 bg-obsidian" rows="3" placeholder="Escreva sua reflex√£o..."></textarea>
                                 <button id="submit-comment-btn" class="text-primary-400 text-[10px] uppercase tracking-[0.2em] hover:text-white transition font-bold border border-primary-900/30 px-6 py-3 hover:bg-primary-900/10">Enviar Oferenda</button>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL DE EDI√á√ÉO DE POSTS -->
        <div id="post-editor-modal" class="view-container hidden fixed inset-0 z-[75] bg-black/95 backdrop-blur-md flex items-center justify-center p-4 overflow-y-auto">
            <div class="w-full max-w-2xl relative bg-royal p-8 border border-primary-500/20 shadow-[0_0_50px_rgba(0,0,0,0.8)] my-auto">
                <button onclick="document.getElementById('post-editor-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-600 hover:text-white transition"><i class="fas fa-times text-2xl"></i></button>
                
                <h3 class="text-xl font-display text-white mb-2 uppercase tracking-widest text-center">Editar Aula Sagrada</h3>
                <div class="h-[1px] w-12 bg-accent mx-auto my-4"></div>
                
                <form id="post-editor-form" class="space-y-4">
                    <div>
                        <label class="text-xs text-primary-500 uppercase tracking-widest mb-2 block">T√≠tulo</label>
                        <input type="text" id="editor-title" class="input-luxe w-full p-3 text-sm" required>
                    </div>
                    
                    <div>
                        <label class="text-xs text-primary-500 uppercase tracking-widest mb-2 block">Subt√≠tulo (Arcano)</label>
                        <input type="text" id="editor-subtitle" class="input-luxe w-full p-3 text-sm" required>
                    </div>
                    
                    <div>
                        <label class="text-xs text-primary-500 uppercase tracking-widest mb-2 block">Link do V√≠deo (Google Drive)</label>
                        <input type="url" id="editor-video" class="input-luxe w-full p-3 text-sm" required>
                    </div>
                    
                    <div>
                        <label class="text-xs text-primary-500 uppercase tracking-widest mb-2 block">Link do PDF (Google Drive)</label>
                        <input type="url" id="editor-pdf" class="input-luxe w-full p-3 text-sm" required>
                    </div>
                    
                    <div>
                        <label class="text-xs text-primary-500 uppercase tracking-widest mb-2 block">Descri√ß√£o</label>
                        <textarea id="editor-content" class="input-luxe w-full p-3 text-sm" rows="3"></textarea>
                    </div>
                    
                    <div class="p-4 bg-black/40 border border-accent/20 rounded">
                        <label class="text-xs text-accent uppercase tracking-widest mb-3 block flex items-center">
                            <i class="fas fa-shield-alt mr-2"></i> Privacidade da Aula
                        </label>
                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="editor-privacy" value="public" class="accent-green-500 h-4 w-4">
                                <span class="text-xs text-green-400 uppercase tracking-wide"><i class="fas fa-eye mr-1"></i>P√∫blica</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="editor-privacy" value="private" class="accent-red-500 h-4 w-4">
                                <span class="text-xs text-red-400 uppercase tracking-wide"><i class="fas fa-lock mr-1"></i>Privada</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button type="submit" class="flex-1 bg-primary-900/20 border border-primary-500 text-primary-400 py-3 text-xs uppercase tracking-[0.3em] hover:bg-primary-500 hover:text-black transition font-bold">Salvar Altera√ß√µes</button>
                        <button type="button" onclick="document.getElementById('post-editor-modal').classList.add('hidden')" class="flex-1 bg-black border border-white/10 text-gray-400 py-3 text-xs uppercase tracking-[0.3em] hover:bg-white/10 transition font-bold">Cancelar</button>
                    </div>
                    
                    <p id="editor-status" class="text-center text-xs text-primary-500 mt-3 h-4"></p>
                </form>
            </div>
        </div>

        <!-- MODAL DE PONTO DE PARTIDA (ADMIN) -->
        <div id="admin-starting-lesson-modal" class="view-container hidden fixed inset-0 z-[70] bg-black/95 backdrop-blur-md flex items-center justify-center p-4 overflow-y-auto">
            <div class="w-full max-w-2xl relative bg-royal p-8 border border-primary-500/20 shadow-[0_0_50px_rgba(0,0,0,0.8)] my-auto">
                <button onclick="document.getElementById('admin-starting-lesson-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-600 hover:text-white transition"><i class="fas fa-times text-2xl"></i></button>
                
                <h3 class="text-xl font-display text-white mb-2 uppercase tracking-widest text-center">Definir Ponto de Partida</h3>
                <p id="admin-lesson-student-email" class="text-xs text-primary-500 uppercase tracking-widest text-center mb-6"></p>
                
                <div id="admin-lesson-selector" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar mb-6">
                    <!-- Op√ß√µes de m√≥dulos e aulas injetadas aqui -->
                </div>
                
                <button id="admin-save-lesson-btn" class="w-full bg-primary-900/20 border border-primary-500 text-primary-400 py-3 text-xs uppercase tracking-[0.3em] hover:bg-primary-500 hover:text-black transition font-bold">Definir Ponto de Partida</button>
                <p id="admin-lesson-status" class="text-center text-xs mt-3 text-primary-500 h-4"></p>
            </div>
        </div>

        <!-- MODAL DE SELE√á√ÉO DE M√ìDULOS -->
        <div id="student-modules-modal" class="view-container hidden fixed inset-0 z-[70] bg-black/95 backdrop-blur-md flex items-center justify-center p-4">
            <div class="w-full max-w-md relative bg-royal p-8 border border-primary-500/20 shadow-[0_0_50px_rgba(0,0,0,0.8)]">
                <button onclick="document.getElementById('student-modules-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-600 hover:text-white transition"><i class="fas fa-times"></i></button>
                
                <h3 class="text-xl font-display text-white mb-2 uppercase tracking-widest text-center">Permiss√µes de Acesso</h3>
                <p id="modal-student-email" class="text-[10px] text-primary-500 uppercase tracking-widest text-center mb-6"></p>
                
                <div id="modal-modules-list" class="space-y-3 max-h-60 overflow-y-auto custom-scrollbar mb-6 p-2">
                    <!-- Checkboxes de m√≥dulos aqui -->
                </div>

                <button id="save-modules-btn" class="w-full bg-primary-900/20 border border-primary-500 text-primary-400 py-3 text-[10px] uppercase tracking-[0.3em] hover:bg-primary-500 hover:text-black transition font-bold">Salvar Permiss√µes</button>
            </div>
        </div>

    </div>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, setDoc, query, deleteDoc, updateDoc, orderBy, increment, where, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDBIIcYpc0UGYOEYUMziqRbRFCKwwFKHWo",
          authDomain: "black-f70c1.firebaseapp.com",
          projectId: "black-f70c1",
          storageBucket: "black-f70c1.firebasestorage.app",
          messagingSenderId: "405843705668",
          appId: "1:405843705668:web:7a6ab1a8bdb2016aaf2111"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // üö® CONFIGURA√á√ÉO DE ADMIN üö®
        const ADMIN_EMAIL = "blacklord@rexlucifer.com"; 

        // STATE
        let currentUser = null;
        let currentUserData = null; // Guardar dados completos para ver datas
        let completedPosts = [];
        let allPosts = [];
        let allSections = [];
        let activeSectionId = null;
        let currentPostId = null;
        let commentsUnsubscribe = null;
        let isRegisterMode = false;
        let studentsUnsubscribe = null; 
        let editingStudentId = null;

        // UI REFS
        const loadingSpinner = document.getElementById('loading-spinner');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        const adminPanel = document.getElementById('admin-panel');
        const sectionsHub = document.getElementById('sections-hub');
        const activePathView = document.getElementById('active-path-view');
        
        // Mobile Menu
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        
        mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
            mobileMenu.classList.toggle('flex');
        });

        // === NAV ===
        window.showView = function(viewId) {
            // Close mobile menu on nav
            mobileMenu.classList.add('hidden');
            mobileMenu.classList.remove('flex');

            ['home-view', 'blog-view', 'profile-view', 'post-view', 'login-view', 'student-modules-modal', 'students-view'].forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    if(id === 'post-view' || id === 'login-view' || id === 'student-modules-modal') el.style.display = 'none'; 
                    else el.style.display = (id === viewId) ? 'block' : 'none';
                }
            });

            if(viewId === 'login-view') {
                document.getElementById('login-view').style.display = 'flex';
                resetLoginForm();
            }
            if(viewId === 'post-view') document.getElementById('post-view').style.display = 'block';

            if(viewId === 'students-view') {
                fetchStudents(); // Ensure data is fresh
            }

            if(viewId === 'blog-view') {
                // VERIFICA ACESSO GLOBAL AO BLOG
                if (currentUserData) {
                    const now = new Date();
                    const expiresAt = currentUserData.accessExpiresAt ? currentUserData.accessExpiresAt.toDate() : null;
                    const isRevoked = currentUserData.isRevoked === true;

                    if (currentUser.email !== ADMIN_EMAIL) {
                        if (isRevoked) {
                            alert("Acesso Revogado pela Alta Ordem.");
                            showView('home-view');
                            return;
                        }
                        if (expiresAt && now > expiresAt) {
                            alert("Seu tempo de inicia√ß√£o expirou. Renove seu acesso.");
                            showView('home-view');
                            return;
                        }
                    }
                }

                if(!activeSectionId) {
                    sectionsHub.classList.remove('hidden');
                    activePathView.classList.add('hidden');
                } else {
                    sectionsHub.classList.add('hidden');
                    activePathView.classList.remove('hidden');
                    renderProfessionalPath(activeSectionId); 
                }
            }
            window.scrollTo(0,0);
        };

        document.querySelectorAll('.internal-link').forEach(btn => {
            btn.addEventListener('click', (e) => showView(e.currentTarget.dataset.view));
        });

        // === AUTH & LOGIN/REGISTER TOGGLE ===
        const toggleRegBtn = document.getElementById('toggle-register-btn');
        const loginTitle = document.getElementById('login-title');
        const loginSubtitle = document.getElementById('login-subtitle');
        const loginSubmitBtn = document.getElementById('login-submit-btn');

        function resetLoginForm() {
            isRegisterMode = false;
            updateLoginUI();
            document.getElementById('login-form').reset();
            document.getElementById('login-error').textContent = "";
        }

        function updateLoginUI() {
            if (isRegisterMode) {
                loginTitle.textContent = "INICIA√á√ÉO";
                loginSubtitle.textContent = "Solicitar Acesso";
                loginSubmitBtn.textContent = "Requerer Entrada";
                toggleRegBtn.textContent = "J√° √© iniciado? Adentrar";
            } else {
                loginTitle.textContent = "SANCTUM";
                loginSubtitle.textContent = "Identifique-se";
                loginSubmitBtn.textContent = "Adentrar";
                toggleRegBtn.textContent = "Solicitar Inicia√ß√£o (Criar Conta)";
            }
        }

        toggleRegBtn.addEventListener('click', () => {
            isRegisterMode = !isRegisterMode;
            updateLoginUI();
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            const errorMsg = document.getElementById('login-error');
            errorMsg.textContent = "Invocando...";

            try {
                if (isRegisterMode) {
                    const cred = await createUserWithEmailAndPassword(auth, email, pass);
                    // DEFAULT: 30 dias de acesso
                    const expires = new Date();
                    expires.setDate(expires.getDate() + 30);
                    
                    await setDoc(doc(db, "users", cred.user.uid), { 
                        email, 
                        createdAt: new Date(), 
                        completedPosts: [],
                        completionDates: {},
                        role: 'student',
                        accessExpiresAt: expires,
                        allowedSections: [], // Nenhuma se√ß√£o por padr√£o, ou todas? Vamos deixar vazio para o admin liberar.
                        isRevoked: false
                    });
                    window.location.reload();
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch (err) {
                console.error(err);
                errorMsg.textContent = "Acesso Negado: " + err.code;
            }
        });

        onAuthStateChanged(auth, async (user) => {
            const mobileActions = document.getElementById('mobile-user-actions');
            mobileActions.innerHTML = ''; // Clear mobile actions

            if (user) {
                currentUser = user;
                userInfo.style.display = 'flex';
                loginBtn.style.display = 'none';
                document.getElementById('header-user-name').textContent = user.email.split('@')[0];
                document.getElementById('profile-email-display').textContent = user.email;
                document.getElementById('comment-form-container').classList.remove('hidden');

                // Mobile Menu Logic for Logged User
                const profileBtn = document.createElement('button');
                profileBtn.className = "text-xs font-display font-bold tracking-[0.2em] text-white py-2 uppercase";
                profileBtn.textContent = "Meu Perfil";
                profileBtn.onclick = () => showView('profile-view');
                mobileActions.appendChild(profileBtn);

                const logoutMbl = document.createElement('button');
                logoutMbl.className = "text-xs font-display font-bold tracking-[0.2em] text-red-500 py-2 uppercase";
                logoutMbl.textContent = "Sair";
                logoutMbl.onclick = () => signOut(auth);
                mobileActions.appendChild(logoutMbl);


                if (user.email === ADMIN_EMAIL) {
                    adminPanel.style.display = 'block'; 
                    document.querySelectorAll('.admin-only-controls').forEach(e => e.classList.remove('hidden'));
                    document.getElementById('profile-admin-badge').classList.remove('hidden');
                    // fetchStudents(); // Removed from here, called when view is opened
                } else {
                    adminPanel.style.display = 'none';
                    document.querySelectorAll('.admin-only-controls').forEach(e => e.classList.add('hidden'));
                    document.getElementById('profile-admin-badge').classList.add('hidden');
                }

                const userDoc = await getDoc(doc(db, "users", user.uid));
                if(userDoc.exists()) {
                    currentUserData = userDoc.data();
                    completedPosts = currentUserData.completedPosts || [];
                    
                    // Show expiration on profile
                    const statusDisplay = document.getElementById('profile-status-display');
                    if(currentUserData.isRevoked) {
                        statusDisplay.textContent = "STATUS: REVOGADO";
                        statusDisplay.className = "text-xs font-bold uppercase tracking-[0.2em] mb-4 text-red-500";
                    } else if (currentUserData.accessExpiresAt) {
                        const expDate = currentUserData.accessExpiresAt.toDate();
                        statusDisplay.textContent = `Vence em: ${expDate.toLocaleDateString()}`;
                        statusDisplay.className = (new Date() > expDate) ? "text-xs font-bold uppercase tracking-[0.2em] mb-4 text-red-500" : "text-xs font-bold uppercase tracking-[0.2em] mb-4 text-green-500";
                    } else {
                        statusDisplay.textContent = "STATUS: INFINITO";
                    }

                    // NOVO: RENDERIZAR SELETOR DE AULA INICIAL (APENAS PARA ALUNOS)
                    if (user.email !== ADMIN_EMAIL) {
                        renderStartingLessonSelector(user.uid);
                    }
                }
                
                if(document.getElementById('login-view').style.display === 'flex') showView('blog-view');
            } else {
                currentUser = null;
                currentUserData = null;
                userInfo.style.display = 'none';
                loginBtn.style.display = 'block';
                adminPanel.style.display = 'none';
                document.querySelectorAll('.admin-only-controls').forEach(e => e.classList.add('hidden'));
                document.getElementById('comment-form-container').classList.add('hidden');
                
                // Mobile Menu for Guest
                const loginMbl = document.createElement('button');
                loginMbl.className = "text-xs font-display font-bold tracking-[0.2em] text-primary-400 py-2 uppercase border border-primary-500/30";
                loginMbl.textContent = "Acesso";
                loginMbl.onclick = () => showView('login-view');
                mobileActions.appendChild(loginMbl);

                if(studentsUnsubscribe) studentsUnsubscribe(); 
            }
            fetchSections();
            fetchPosts();
        });

        document.getElementById('login-btn').addEventListener('click', () => showView('login-view'));
        document.getElementById('close-login-btn').addEventListener('click', () => showView('home-view'));
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        // === DATA ===
        function fetchSections() {
            onSnapshot(query(collection(db, "sections"), orderBy("name")), (snap) => {
                allSections = [];
                const select = document.getElementById('post-section');
                const container = document.getElementById('sections-cards-container');
                const listAdmin = document.getElementById('sections-list-admin');
                const privacyList = document.getElementById('sections-privacy-list');
                const sectionCount = document.getElementById('section-count');
                
                select.innerHTML = '<option value="">Selecione o Caminho</option>';
                container.innerHTML = '';
                listAdmin.innerHTML = '';
                privacyList.innerHTML = '';
                
                let count = 0;

                snap.forEach(d => {
                    count++;
                    const s = { id: d.id, ...d.data() };
                    allSections.push(s);
                    select.add(new Option(s.name, s.id));
                    
                    // Admin List Item (Enhanced)
                    const item = document.createElement('div');
                    item.className = "flex justify-between items-center p-2 bg-white/5 border border-white/5 hover:bg-white/10 transition";
                    item.innerHTML = `
                        <span class="text-xs uppercase tracking-wider text-gray-300 font-display truncate">${s.name}</span>
                        <button onclick="deleteSection('${s.id}')" class="text-red-900 hover:text-red-500 transition px-2" title="Apagar Trilha">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    listAdmin.appendChild(item);

                    // NOVO: Privacy Toggle Item
                    const privacyItem = document.createElement('div');
                    privacyItem.className = "flex justify-between items-center p-3 bg-white/5 border border-accent/20 hover:bg-white/10 transition rounded";
                    const sectionIsPrivate = s.isPrivate === true;
                    privacyItem.innerHTML = `
                        <div class="flex-1">
                            <span class="text-xs uppercase tracking-wider text-accent font-display block">${s.name}</span>
                            <span class="text-[9px] text-gray-600">${sectionIsPrivate ? 'üîí Privado' : 'üëÅÔ∏è P√∫blico'}</span>
                        </div>
                        <button onclick="toggleSectionPrivacy('${s.id}', ${sectionIsPrivate})" class="px-4 py-2 rounded transition text-xs uppercase tracking-widest font-bold ${sectionIsPrivate ? 'bg-red-900/30 border border-red-500/50 text-red-400 hover:bg-red-500 hover:text-black' : 'bg-green-900/30 border border-green-500/50 text-green-400 hover:bg-green-500 hover:text-black'}">
                            ${sectionIsPrivate ? '<i class="fas fa-lock mr-1"></i> Privatizar' : '<i class="fas fa-eye mr-1"></i> Publicar'}
                        </button>
                    `;
                    privacyList.appendChild(privacyItem);
                    
                    // L√ìGICA DE FILTRAGEM DE M√ìDULOS PARA O ALUNO
                    let isAllowed = true;
                    let hasPermission = true;
                    const isPrivate = s.isPrivate === true;
                    
                    if (isPrivate && !currentUser) {
                        // M√≥dulo privado - n√£o mostra para deslogados
                        isAllowed = false;
                    } else if (currentUser && currentUser.email !== ADMIN_EMAIL) {
                        // Para alunos logados: mostrar todos, mas verificar permiss√£o
                        isAllowed = true;
                        hasPermission = currentUserData?.allowedSections?.includes(s.id) ?? false;
                    } else {
                        hasPermission = true; // Admin tem permiss√£o em tudo
                    }

                    if (isAllowed) {
                        const card = document.createElement('div');
                        card.className = "project-card border border-white/5 p-6 md:p-10 relative group cursor-pointer flex flex-col items-center justify-center text-center min-h-[250px] md:min-h-[300px] " + (!hasPermission ? 'opacity-60 hover:opacity-100' : '');
                        card.style.cursor = hasPermission ? 'pointer' : 'not-allowed';
                        
                        if (hasPermission) {
                            card.onclick = () => openPath(s.id, s.name);
                        } else {
                            card.onclick = () => alert('üìö Voc√™ ainda n√£o tem permiss√£o para acessar esta trilha.\n\nSolicite ao administrador para liberar seu acesso.');
                        }
                        
                        const lockIcon = !hasPermission ? '<div class="absolute top-4 right-4 bg-red-900/50 border border-red-500 rounded-full p-3 text-red-400"><i class="fas fa-lock text-lg"></i></div>' : '';
                        
                        card.innerHTML = `
                            <div class="absolute inset-0 bg-[radial-gradient(circle,rgba(255,215,0,0.1)_0%,rgba(0,0,0,0)_70%)] opacity-0 group-hover:opacity-100 transition duration-700"></div>
                            <i class="fas fa-dharmachakra text-5xl md:text-6xl text-gray-800 mb-6 md:mb-8 group-hover:text-primary-500 transition transform group-hover:rotate-180 duration-1000"></i>
                            <h4 class="text-xl md:text-2xl font-display text-white mb-2 group-hover:text-primary-400 transition uppercase tracking-widest">${s.name}</h4>
                            <p class="text-[9px] text-gray-600 uppercase tracking-[0.4em]">${hasPermission ? 'Adentrar Portal' : 'üîí Sem Acesso'}</p>
                            ${lockIcon}
                        `;
                        container.appendChild(card);
                    }
                });
                sectionCount.textContent = `${count} Trilhas`;
                if(count === 0) listAdmin.innerHTML = '<p class="text-gray-600 text-xs italic text-center py-4">Nenhuma trilha criada.</p>';
                updatePostsPrivacySectionSelect(); // Atualizar select de se√ß√µes
            });
        }

        function fetchPosts() {
            onSnapshot(query(collection(db, "posts"), orderBy("createdAt", "asc")), (snap) => {
                allPosts = [];
                snap.forEach(d => allPosts.push({ id: d.id, ...d.data() }));
                if(activeSectionId) renderProfessionalPath(activeSectionId);
            });
        }

        // === ADMIN LOGIC (STUDENTS NEW VIEW) ===
        function fetchStudents() {
            const tableBody = document.getElementById('students-table-body');
            const loading = document.getElementById('students-loading');
            const empty = document.getElementById('students-empty');
            
            if(studentsUnsubscribe) studentsUnsubscribe();
            
            loading.classList.remove('hidden');
            tableBody.innerHTML = '';
            empty.classList.add('hidden');

            studentsUnsubscribe = onSnapshot(query(collection(db, "users")), (snap) => {
                loading.classList.add('hidden');
                tableBody.innerHTML = '';
                let count = 0;
                
                snap.forEach(d => {
                    if (d.data().email === ADMIN_EMAIL) return; 
                    
                    count++;
                    const user = d.data();
                    const uid = d.id;
                    
                    // C√°lculo de Vencimento
                    let expiryText = "Sem data";
                    let statusColor = "text-gray-500";
                    let isExpired = false;
                    
                    if (user.accessExpiresAt) {
                        const expDate = user.accessExpiresAt.toDate();
                        const now = new Date();
                        const diffTime = expDate - now;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                        
                        if (diffDays < 0) {
                            expiryText = "EXPIRADO";
                            statusColor = "text-orange-500 font-bold";
                            isExpired = true;
                        } else {
                            expiryText = `${expDate.toLocaleDateString()} (${diffDays} dias)`;
                            statusColor = "text-green-500";
                        }
                    }

                    let statusLabel = `<span class="${statusColor}">${expiryText}</span>`;
                    if (user.isRevoked) {
                        statusLabel = `<span class="text-red-600 font-bold"><i class="fas fa-ban mr-1"></i> BANIDO</span>`;
                    } else if (!isExpired) {
                        statusLabel = `<span class="text-green-500"><i class="fas fa-check-circle mr-1"></i> ATIVO (${expiryText})</span>`;
                    }

                    const revokeIcon = user.isRevoked ? 'fa-user-check' : 'fa-skull';
                    const revokeTitle = user.isRevoked ? 'Reativar Acesso' : 'Revogar Acesso (Banir)';
                    const revokeColor = user.isRevoked ? 'text-green-500 border-green-500/30' : 'text-red-500 border-red-500/30';

                    const row = document.createElement('tr');
                    row.className = "hover:bg-white/5 transition";
                    row.innerHTML = `
                        <td class="p-4 border-b border-white/5 font-display text-gray-200">${user.email}</td>
                        <td class="p-4 border-b border-white/5 text-xs uppercase tracking-wider">${user.isRevoked ? 'BANIDO' : (isExpired ? 'EXPIRADO' : 'ATIVO')}</td>
                        <td class="p-4 border-b border-white/5 text-xs font-mono">${statusLabel}</td>
                        <td class="p-4 border-b border-white/5 text-right">
                            <div class="flex gap-2 justify-end">
                                <button onclick="manageStudent('${uid}', 'modules', '${user.email}')" class="bg-black border border-primary-500/30 text-primary-400 hover:bg-primary-500 hover:text-black px-3 py-2 text-xs transition" title="Permiss√µes de M√≥dulos"><i class="fas fa-book"></i></button>
                                <button onclick="openStartingLessonAdminModal('${uid}', '${user.email}')" class="bg-black border border-accent/30 text-accent hover:bg-accent hover:text-black px-3 py-2 text-xs transition" title="Ponto de Partida"><i class="fas fa-graduation-cap"></i></button>
                                <button onclick="manageStudent('${uid}', 'addMonth')" class="bg-black border border-green-500/30 text-green-400 hover:bg-green-500 hover:text-black px-3 py-2 text-xs transition" title="+1 M√™s"><i class="fas fa-calendar-plus"></i></button>
                                <button onclick="manageStudent('${uid}', 'subMonth')" class="bg-black border border-orange-500/30 text-orange-400 hover:bg-orange-500 hover:text-black px-3 py-2 text-xs transition" title="-1 M√™s"><i class="fas fa-calendar-minus"></i></button>
                                <button onclick="manageStudent('${uid}', 'toggleRevoke')" class="bg-black border ${revokeColor} hover:bg-red-500 hover:text-black px-3 py-2 text-xs transition" title="${revokeTitle}"><i class="fas ${revokeIcon}"></i></button>
                                <button onclick="deleteStudent('${uid}')" class="bg-black border border-red-900/30 text-red-900 hover:bg-red-900 hover:text-white px-3 py-2 text-xs transition" title="Excluir Definitivamente"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                if (count === 0) empty.classList.remove('hidden');
            });
        }

        window.manageStudent = async (uid, action, email = "") => {
            const userRef = doc(db, "users", uid);
            const userSnap = await getDoc(userRef);
            if (!userSnap.exists()) return;
            
            const userData = userSnap.data();
            let newDate = userData.accessExpiresAt ? userData.accessExpiresAt.toDate() : new Date();

            try {
                if (action === 'addMonth') {
                    newDate.setDate(newDate.getDate() + 30);
                    await updateDoc(userRef, { accessExpiresAt: newDate, isRevoked: false }); // Se adicionar tempo, desbane se tiver banido
                } 
                else if (action === 'subMonth') {
                    newDate.setDate(newDate.getDate() - 30);
                    await updateDoc(userRef, { accessExpiresAt: newDate });
                }
                else if (action === 'toggleRevoke') {
                    await updateDoc(userRef, { isRevoked: !userData.isRevoked });
                }
                else if (action === 'modules') {
                    openModuleModal(uid, email, userData.allowedSections || []);
                }
            } catch(e) {
                console.error(e);
                alert("Erro ao executar ritual administrativo.");
            }
        };

        // MODULE MODAL LOGIC
        function openModuleModal(uid, email, allowedSections) {
            editingStudentId = uid;
            const modal = document.getElementById('student-modules-modal');
            const list = document.getElementById('modal-modules-list');
            document.getElementById('modal-student-email').textContent = email;
            
            list.innerHTML = '';
            
            if (allSections.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-xs italic">Crie trilhas primeiro.</p>';
            } else {
                allSections.forEach(sec => {
                    const isChecked = allowedSections.includes(sec.id) ? 'checked' : '';
                    const div = document.createElement('div');
                    div.className = "flex items-center gap-3 p-2 border border-white/5 bg-black/50 hover:bg-white/5 transition";
                    div.innerHTML = `
                        <input type="checkbox" id="chk-${sec.id}" value="${sec.id}" ${isChecked} class="accent-primary-500 h-4 w-4">
                        <label for="chk-${sec.id}" class="text-gray-300 text-xs uppercase tracking-wider cursor-pointer select-none flex-1 font-display">${sec.name}</label>
                    `;
                    list.appendChild(div);
                });
            }
            
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        document.getElementById('save-modules-btn').addEventListener('click', async () => {
            if (!editingStudentId) return;
            
            const checkboxes = document.querySelectorAll('#modal-modules-list input[type="checkbox"]');
            const selectedIds = [];
            checkboxes.forEach(chk => {
                if (chk.checked) selectedIds.push(chk.value);
            });

            try {
                await updateDoc(doc(db, "users", editingStudentId), { allowedSections: selectedIds });
                document.getElementById('student-modules-modal').classList.add('hidden');
                document.getElementById('student-modules-modal').style.display = 'none';
                editingStudentId = null;
            } catch(e) {
                console.error(e);
                alert("Falha ao salvar permiss√µes.");
            }
        });

        document.getElementById('create-account-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('new-email').value;
            const pass = document.getElementById('new-password').value;
            const status = document.getElementById('account-status');
            const btn = document.getElementById('create-student-btn');

            status.textContent = "Registrando...";
            btn.disabled = true;

            try {
                const secondaryApp = initializeApp(firebaseConfig, "SecondaryApp");
                const secondaryAuth = getAuth(secondaryApp);
                const userCred = await createUserWithEmailAndPassword(secondaryAuth, email, pass);
                
                // DATA DE EXPIRA√á√ÉO PADR√ÉO: +30 DIAS
                const expires = new Date();
                expires.setDate(expires.getDate() + 30);

                await setDoc(doc(db, "users", userCred.user.uid), {
                    email: email, 
                    createdAt: new Date(), 
                    completedPosts: [], 
                    completionDates: {}, 
                    role: 'student',
                    accessExpiresAt: expires,
                    allowedSections: [], // Nenhuma se√ß√£o por padr√£o
                    isRevoked: false
                });
                await signOut(secondaryAuth);
                await deleteApp(secondaryApp);

                status.textContent = "Iniciado Registrado.";
                status.className = "text-xs h-4 text-center text-primary-400";
                document.getElementById('create-account-form').reset();
            } catch (err) {
                status.textContent = "Erro: " + err.code;
                status.className = "text-xs h-4 text-center text-red-500";
            }
            btn.disabled = false;
        });

        window.deleteStudent = async (uid) => {
            if(confirm("Banir e deletar este iniciado da Ordem permanentemente?")) {
                try { await deleteDoc(doc(db, "users", uid)); } catch(e) { console.error(e); }
            }
        };

        // NOVO: RENDERIZAR SELETOR DE AULA INICIAL
        function renderStartingLessonSelector(uid) {
            const container = document.getElementById('starting-lesson-select-wrapper');
            const startingLessonContainer = document.getElementById('starting-lesson-container');
            
            if (!allPosts || allPosts.length === 0) {
                startingLessonContainer.classList.add('hidden');
                return;
            }

            container.innerHTML = '';
            let hasStartingLesson = false;

            const orderedPosts = allPosts.slice().sort((a,b) => (a.createdAt?.seconds||0) - (b.createdAt?.seconds||0));

            orderedPosts.forEach((post, index) => {
                const isSelected = currentUserData?.startingLessonIndex === index;
                if (isSelected) hasStartingLesson = true;

                const option = document.createElement('div');
                option.className = `flex items-center gap-3 p-3 bg-black/50 border transition cursor-pointer rounded ${isSelected ? 'border-primary-500 bg-primary-900/20' : 'border-white/10 hover:border-primary-500/50'}`;
                option.innerHTML = `
                    <input type="radio" name="starting-lesson" value="${index}" ${isSelected ? 'checked' : ''} class="accent-primary-500 h-4 w-4">
                    <div class="flex-1 min-w-0">
                        <div class="text-xs font-display text-white truncate">Aula ${index + 1}</div>
                        <div class="text-[9px] text-gray-500 truncate">${post.title}</div>
                    </div>
                `;
                option.addEventListener('click', () => {
                    document.querySelector(`input[value="${index}"]`).checked = true;
                });
                container.appendChild(option);
            });

            startingLessonContainer.classList.remove('hidden');

            document.getElementById('save-starting-lesson-btn').onclick = async () => {
                const selectedIndex = parseInt(document.querySelector('input[name="starting-lesson"]:checked')?.value || -1);
                if (selectedIndex === -1) {
                    alert("Selecione uma aula para come√ßar.");
                    return;
                }

                const statusEl = document.getElementById('lesson-save-status');
                statusEl.textContent = "Salvando...";

                try {
                    await updateDoc(doc(db, "users", uid), { 
                        startingLessonIndex: selectedIndex,
                        completedPosts: allPosts.slice(0, selectedIndex).map(p => p.id) // Marca todas as aulas anteriores como completas
                    });
                    
                    // Atualizar estado local
                    completedPosts = currentUserData.completedPosts.slice();
                    
                    statusEl.textContent = "‚úÖ Ponto de partida confirmado!";
                    setTimeout(() => statusEl.textContent = "", 2000);
                } catch (e) {
                    console.error(e);
                    statusEl.textContent = "‚ùå Erro ao salvar.";
                    statusEl.className = "text-center text-xs mt-2 text-red-500";
                    setTimeout(() => statusEl.textContent = "", 3000);
                }
            };
        };

        document.getElementById('create-section-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const n = document.getElementById('section-name').value;
            if(n) { await addDoc(collection(db, "sections"), { name: n, createdAt: new Date() }); e.target.reset(); }
        });

        window.deleteSection = async (id) => { if(confirm("Selar este Caminho (Excluir Trilha)?")) await deleteDoc(doc(db, "sections", id)); };

        // NOVO: TOGGLE PRIVACIDADE DE M√ìDULO
        window.toggleSectionPrivacy = async (sectionId, isCurrentlyPrivate) => {
            try {
                const sectionRef = doc(db, "sections", sectionId);
                await updateDoc(sectionRef, { isPrivate: !isCurrentlyPrivate });
            } catch (e) {
                console.error(e);
                alert("Erro ao alterar privacidade do m√≥dulo.");
            }
        };

        document.getElementById('create-post-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const status = document.getElementById('post-status');
            status.textContent = "Consagrando...";
            const secSelect = document.getElementById('post-section');
            try {
                await addDoc(collection(db, "posts"), {
                    title: document.getElementById('post-title').value,
                    subtitle: document.getElementById('post-subtitle').value,
                    videoURL: document.getElementById('post-video-link').value,
                    pdfURL: document.getElementById('post-pdf-link').value,
                    content: document.getElementById('post-content').value,
                    access: document.getElementById('post-access').value,
                    sectionId: secSelect.value,
                    createdAt: new Date()
                });
                status.textContent = "Ritual Arquivado.";
                e.target.reset();
            } catch(err) { console.error(err); status.textContent = "Falha no rito."; }
        });

        function openPath(id, name) {
            // Verificar se aluno tem permiss√£o
            if (currentUser && currentUser.email !== ADMIN_EMAIL) {
                if (!currentUserData?.allowedSections?.includes(id)) {
                    alert('üîí Voc√™ n√£o tem permiss√£o para acessar esta trilha.\n\nSolicite ao administrador para liberar seu acesso.');
                    return;
                }
            }
            
            activeSectionId = id;
            document.getElementById('path-title').textContent = name;
            document.getElementById('sections-hub').classList.add('hidden');
            document.getElementById('active-path-view').classList.remove('hidden');
            renderProfessionalPath(id);
        }

        document.getElementById('back-to-hub-btn').addEventListener('click', () => {
            activeSectionId = null;
            document.getElementById('active-path-view').classList.add('hidden');
            document.getElementById('sections-hub').classList.remove('hidden');
        });

        // Add Resize Event Listener to redraw path
        window.addEventListener('resize', () => {
            if(activeSectionId && !document.getElementById('active-path-view').classList.contains('hidden')) {
                renderProfessionalPath(activeSectionId);
            }
        });

        // üï∞Ô∏è HELPER DE DATA PARA O C√ÅLCULO DE TRAVA DE TEMPO üï∞Ô∏è
        function getNextMonday(date) {
            const d = new Date(date);
            d.setDate(d.getDate() + ((7 - d.getDay() + 1) % 7 || 7));
            d.setHours(0,0,0,0);
            return d;
        }

        function renderProfessionalPath(sectionId) {
            const container = document.getElementById('path-steps-container');
            container.innerHTML = '';
            
            // 1. Pega e ordena os posts da trilha
            let posts = allPosts.filter(p => p.sectionId === sectionId).sort((a,b) => (a.createdAt?.seconds||0) - (b.createdAt?.seconds||0));
            
            // 2. NOVO: Filtrar posts privados para deslogados
            if (!currentUser) {
                posts = posts.filter(p => p.isPrivate !== true);
            }
            
            if(posts.length === 0) {
                document.getElementById('empty-path-msg').classList.remove('hidden');
                return;
            }
            document.getElementById('empty-path-msg').classList.add('hidden');

            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("class", "path-svg-line");
            
            // Responsive sizing
            const isMobile = window.innerWidth < 768;
            const spacing = isMobile ? 140 : 180;
            const totalHeight = (posts.length * spacing) + 200;
            const curveWidth = isMobile ? 60 : 120; // Menor curva no mobile

            container.style.height = totalHeight + 'px';
            svg.style.height = totalHeight + 'px';
            container.appendChild(svg);

            let pathD = "";
            const centerX = container.offsetWidth / 2;
            let prevX = centerX;
            let prevY = 50;

            // üï∞Ô∏è L√ìGICA DE GRUPOS DE 3 (SEMANAL)
            let maxUnlockedIndex = 9999;
            
            if (currentUser && currentUser.email !== ADMIN_EMAIL) {
                maxUnlockedIndex = 0; 
                for (let group = 0; group < 100; group++) {
                    const lastPostOfPrevGroupIndex = ((group) * 3) - 1; 
                    if (lastPostOfPrevGroupIndex < 0) { maxUnlockedIndex = 2; continue; }
                    if (lastPostOfPrevGroupIndex >= posts.length) break;
                    const lastPostOfPrevGroup = posts[lastPostOfPrevGroupIndex];
                    
                    if (completedPosts.includes(lastPostOfPrevGroup.id)) {
                        let compDate = new Date(0); 
                        if (currentUserData && currentUserData.completionDates && currentUserData.completionDates[lastPostOfPrevGroup.id]) {
                            compDate = currentUserData.completionDates[lastPostOfPrevGroup.id].toDate();
                        }
                        const unlockDate = getNextMonday(compDate);
                        const now = new Date();
                        if (now >= unlockDate) { maxUnlockedIndex = ((group + 1) * 3) - 1; } 
                        else { break; }
                    } else { break; }
                }
            }

            // --- NOVO: MONITOR DE CICLO SEMANAL ---
            const statusContainer = document.getElementById('weekly-status-container');
            if (currentUser && currentUser.email !== ADMIN_EMAIL) {
                statusContainer.classList.remove('hidden');
                
                // Determina o √∫ltimo post do lote atual
                const targetIndex = Math.min(maxUnlockedIndex, posts.length - 1);
                const targetPost = posts[targetIndex];

                if (targetPost) {
                    const isTargetDone = completedPosts.includes(targetPost.id);
                    
                    if (isTargetDone) {
                        statusContainer.innerHTML = `
                            <div class="text-green-500 font-display text-sm tracking-widest uppercase mb-2"><i class="fas fa-check-circle mr-2"></i>Ciclo Conclu√≠do</div>
                            <p class="text-xs text-gray-400">Voc√™ dominou o conhecimento desta semana. O pr√≥ximo selo se abrir√° na pr√≥xima <strong class="text-white">Segunda-feira</strong>.</p>
                        `;
                        statusContainer.className = "max-w-md mx-auto mb-10 p-6 border border-green-900/30 bg-green-900/10 text-center relative z-20 shadow-[0_0_20px_rgba(0,255,0,0.1)]";
                    } else {
                        statusContainer.innerHTML = `
                            <div class="text-red-500 font-display text-sm tracking-widest uppercase mb-2"><i class="fas fa-exclamation-circle mr-2"></i>Ciclo Pendente</div>
                            <p class="text-xs text-gray-400">Complete as 3 aulas sagradas desta semana. Se falhar, o pr√≥ximo caminho <strong class="text-red-400">n√£o se abrir√°</strong> na segunda-feira.</p>
                        `;
                        statusContainer.className = "max-w-md mx-auto mb-10 p-6 border border-red-900/30 bg-red-900/10 text-center relative z-20 shadow-[0_0_20px_rgba(255,0,0,0.1)]";
                    }
                } else {
                    statusContainer.classList.add('hidden');
                }
            } else {
                statusContainer.classList.add('hidden'); // Esconde para admin ou deslogado
            }
            // ----------------------------------------

            posts.forEach((p, i) => {
                const isCompleted = completedPosts.includes(p.id);
                const isAdmin = currentUser && currentUser.email === ADMIN_EMAIL;
                
                let isLocked = false;
                let isTimeLocked = false;

                if (!isAdmin) {
                    if (i > maxUnlockedIndex) { isLocked = true; isTimeLocked = true; } 
                    else if (i > 0 && !completedPosts.includes(posts[i-1].id)) { isLocked = true; }
                }
                
                // SVG Drawing
                const y = 50 + (i * spacing);
                const x = centerX + Math.sin(i * 1.5) * curveWidth;

                if (i === 0) pathD += `M ${x} ${y}`;
                else pathD += ` Q ${prevX} ${(prevY + y) / 2}, ${x} ${y}`;
                prevX = x; prevY = y;

                const node = document.createElement('div');
                node.className = "path-node-wrapper";
                node.style.left = x + 'px';
                node.style.top = y + 'px';
                
                let statusClass = isLocked ? 'status-locked' : (isCompleted ? 'status-completed' : 'status-active');
                if (isTimeLocked) statusClass += ' status-time-locked';

                let icon = isLocked ? 'fa-lock' : (isCompleted ? 'fa-crown' : 'fa-fire');
                if (isTimeLocked) icon = 'fa-hourglass-half';

                let clickFn = `openClass('${p.id}')`;
                if (isTimeLocked) {
                    clickFn = "alert('‚è≥ O selo deste conhecimento s√≥ se romper√° na pr√≥xima segunda-feira, ap√≥s a conclus√£o do ciclo anterior.')";
                } else if (isLocked) {
                    clickFn = "alert('üîí O conhecimento deve ser conquistado em ordem. Complete o rito anterior.')";
                }

                const editBtnHtml = (currentUser && currentUser.email === ADMIN_EMAIL) ? 
                    `<button onclick="event.stopPropagation(); openPostEditor('${p.id}')" class="absolute -top-3 -right-3 bg-primary-900/40 border border-primary-500/70 text-primary-300 hover:bg-primary-500 hover:text-black px-2 py-1 text-xs rounded-full transition z-10 hover:scale-110" title="Editar Aula\"><i class="fas fa-edit text-lg\"></i></button>` : ''

                const tooltipHtml = isTimeLocked ? 
                    `<div class="locked-tooltip"><i class="fas fa-moon mr-1"></i> Aguarde a pr√≥xima<br>Segunda-feira</div>` : 
                    `<div class="node-label">${p.title}</div>`;

                node.innerHTML = `
                    <div class="game-node ${statusClass} relative" onclick="${clickFn}">
                        <i class="fas ${icon}"></i>
                        ${editBtnHtml}
                    </div>
                    ${tooltipHtml}
                `;
                container.appendChild(node);
            });

            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", pathD);
            path.setAttribute("stroke", "#333");
            path.setAttribute("stroke-width", "4");
            path.setAttribute("fill", "none");
            svg.appendChild(path);
        }

        window.openClass = function(id) { openPost(id); }

        // NOVO: ABRIR EDITOR DE POST
        let editingPostId = null;
        window.openPostEditor = async function(postId) {
            editingPostId = postId;
            const snap = await getDoc(doc(db, "posts", postId));
            if (!snap.exists()) {
                alert("Post n√£o encontrado.");
                return;
            }
            
            const post = snap.data();
            document.getElementById('editor-title').value = post.title || '';
            document.getElementById('editor-subtitle').value = post.subtitle || '';
            document.getElementById('editor-video').value = post.videoURL || '';
            document.getElementById('editor-pdf').value = post.pdfURL || '';
            document.getElementById('editor-content').value = post.content || '';
            document.getElementById('editor-status').textContent = '';
            
            // Definir privacidade
            const isPrivate = post.isPrivate === true;
            document.querySelector('input[name="editor-privacy"][value="' + (isPrivate ? 'private' : 'public') + '"]').checked = true;
            
            document.getElementById('post-editor-modal').classList.remove('hidden');
        };

        document.getElementById('post-editor-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!editingPostId) return;
            
            const status = document.getElementById('editor-status');
            status.textContent = 'Salvando...';
            status.className = 'text-center text-xs mt-3 text-primary-500 h-4';
            
            const isPrivate = document.querySelector('input[name="editor-privacy"]:checked').value === 'private';
            
            try {
                await updateDoc(doc(db, "posts", editingPostId), {
                    title: document.getElementById('editor-title').value,
                    subtitle: document.getElementById('editor-subtitle').value,
                    videoURL: document.getElementById('editor-video').value,
                    pdfURL: document.getElementById('editor-pdf').value,
                    content: document.getElementById('editor-content').value,
                    isPrivate: isPrivate
                });
                
                status.textContent = '‚úÖ Aula atualizada com sucesso!';
                status.className = 'text-center text-xs mt-3 text-green-500 h-4';
                setTimeout(() => {
                    document.getElementById('post-editor-modal').classList.add('hidden');
                    if (activeSectionId) renderProfessionalPath(activeSectionId);
                    renderPostsPrivacyList(); // Atualizar lista de privacidade
                }, 1500);
            } catch (e) {
                console.error(e);
                status.textContent = '‚ùå Erro ao salvar aula.';
                status.className = 'text-center text-xs mt-3 text-red-500 h-4';
            }
        });

        // NOVO: MODAL ADMIN PARA ESCOLHER PONTO DE PARTIDA
        let adminEditingStudentId = null;
        window.openStartingLessonAdminModal = function(uid, email) {
            adminEditingStudentId = uid;
            document.getElementById('admin-lesson-student-email').textContent = email;
            
            const selector = document.getElementById('admin-lesson-selector');
            selector.innerHTML = '';
            
            // Agrupar posts por se√ß√£o
            const sections = allSections.reduce((acc, sec) => {
                const sectionPosts = allPosts.filter(p => p.sectionId === sec.id).sort((a,b) => (a.createdAt?.seconds||0) - (b.createdAt?.seconds||0));
                if (sectionPosts.length > 0) {
                    acc.push({ section: sec, posts: sectionPosts });
                }
                return acc;
            }, []);
            
            sections.forEach(({ section, posts }) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'border border-white/10 rounded p-3 bg-black/30';
                groupDiv.innerHTML = `<div class="text-xs text-primary-400 font-display uppercase tracking-wider mb-2"><i class="fas fa-book mr-2"></i>${section.name}</div>`;
                
                posts.forEach((post, idx) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'flex items-center gap-2 p-2 bg-white/5 hover:bg-white/10 rounded mb-1 cursor-pointer';
                    optionDiv.innerHTML = `
                        <input type="radio" name="admin-lesson" value="${post.id}" class="accent-primary-500">
                        <div class="flex-1 min-w-0">
                            <div class="text-[10px] text-white truncate">Aula ${idx + 1}: ${post.title}</div>
                        </div>
                    `;
                    optionDiv.addEventListener('click', () => {
                        document.querySelector(`input[value="${post.id}"]`).checked = true;
                    });
                    groupDiv.appendChild(optionDiv);
                });
                
                selector.appendChild(groupDiv);
            });
            
            document.getElementById('admin-starting-lesson-modal').classList.remove('hidden');
        };

        document.getElementById('admin-save-lesson-btn').addEventListener('click', async () => {
            if (!adminEditingStudentId) return;
            
            const selectedPostId = document.querySelector('input[name="admin-lesson"]:checked')?.value;
            if (!selectedPostId) {
                alert('Selecione uma aula para come√ßar.');
                return;
            }
            
            // Encontrar o √≠ndice global do post
            const allPostsSorted = allPosts.slice().sort((a,b) => (a.createdAt?.seconds||0) - (b.createdAt?.seconds||0));
            const startingIndex = allPostsSorted.findIndex(p => p.id === selectedPostId);
            
            if (startingIndex === -1) return;
            
            const status = document.getElementById('admin-lesson-status');
            status.textContent = 'Salvando...';
            
            try {
                await updateDoc(doc(db, "users", adminEditingStudentId), {
                    startingLessonIndex: startingIndex,
                    completedPosts: allPostsSorted.slice(0, startingIndex).map(p => p.id)
                });
                
                status.textContent = '‚úÖ Ponto de partida definido!';
                status.className = 'text-center text-xs mt-3 text-green-500 h-4';
                setTimeout(() => {
                    document.getElementById('admin-starting-lesson-modal').classList.add('hidden');
                }, 1500);
            } catch (e) {
                console.error(e);
                status.textContent = '‚ùå Erro ao salvar.';
                status.className = 'text-center text-xs mt-3 text-red-500 h-4';
            }
        });

        // NOVO: GERENCIAR PRIVACIDADE DE AULAS
        document.getElementById('admin-posts-section-select').addEventListener('change', (e) => {
            renderPostsPrivacyList(e.target.value);
        });

        function renderPostsPrivacyList(sectionId = '') {
            const list = document.getElementById('posts-privacy-list');
            list.innerHTML = '';
            
            if (!sectionId) {
                list.innerHTML = '<p class="text-gray-600 text-xs italic text-center py-6">Selecione uma trilha acima para ver as aulas.</p>';
                return;
            }
            
            const sectionPosts = allPosts.filter(p => p.sectionId === sectionId).sort((a,b) => (a.createdAt?.seconds||0) - (b.createdAt?.seconds||0));
            
            if (sectionPosts.length === 0) {
                list.innerHTML = '<p class="text-gray-600 text-xs italic text-center py-6">Nenhuma aula nesta trilha.</p>';
                return;
            }
            
            sectionPosts.forEach((post, idx) => {
                const isPrivate = post.isPrivate === true;
                const item = document.createElement('div');
                item.className = "flex justify-between items-center p-3 bg-black/50 border transition rounded " + (isPrivate ? 'border-red-500/30' : 'border-green-500/30');
                item.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <div class="text-xs font-display text-white truncate">Aula ${idx + 1}</div>
                        <div class="text-[9px] text-gray-400 truncate">${post.title}</div>
                        <div class="text-[8px] mt-1">${isPrivate ? '<i class="fas fa-lock text-red-400 mr-1"></i><span class="text-red-400">Privada</span>' : '<i class="fas fa-eye text-green-400 mr-1"></i><span class="text-green-400">P√∫blica</span>'}</div>
                    </div>
                    <button onclick="togglePostPrivacy('${post.id}', ${isPrivate})" class="px-3 py-2 rounded transition text-xs uppercase tracking-widest font-bold ml-2 flex-shrink-0 ${isPrivate ? 'bg-red-900/30 border border-red-500/50 text-red-400 hover:bg-red-500 hover:text-black' : 'bg-green-900/30 border border-green-500/50 text-green-400 hover:bg-green-500 hover:text-black'}">
                        ${isPrivate ? '<i class="fas fa-lock mr-1"></i> Publicar' : '<i class="fas fa-eye-slash mr-1"></i> Privatizar'}
                    </button>
                `;
                list.appendChild(item);
            });
        }

        // Fun√ß√£o para alternar privacidade de posts
        window.togglePostPrivacy = async function(postId, isCurrentlyPrivate) {
            try {
                await updateDoc(doc(db, "posts", postId), { isPrivate: !isCurrentlyPrivate });
                const sectionId = document.getElementById('admin-posts-section-select').value;
                if (sectionId) renderPostsPrivacyList(sectionId);
            } catch (e) {
                console.error(e);
                alert("Erro ao alterar privacidade da aula.");
            }
        };

        // Atualizar select de se√ß√µes no painel de privacidade de aulas
        function updatePostsPrivacySectionSelect() {
            const select = document.getElementById('admin-posts-section-select');
            const currentValue = select.value;
            select.innerHTML = '<option value="">Escolha uma trilha...</option>';
            
            allSections.forEach(sec => {
                const option = document.createElement('option');
                option.value = sec.id;
                option.textContent = sec.name;
                select.appendChild(option);
            });
            
            select.value = currentValue;
        }

        function getDriveEmbedLink(url) {
            if (!url) return '';
            if (url.includes('drive.google.com')) {
                return url.replace(/\/view.*/, '/preview').replace(/\/edit.*/, '/preview');
            }
            return url;
        }

        async function openPost(id) {
            loadingSpinner.classList.remove('hidden');
            const snap = await getDoc(doc(db, "posts", id));
            if(snap.exists()) {
                const p = snap.data();
                currentPostId = id;
                document.getElementById('post-view-title').textContent = p.title;
                document.getElementById('post-view-subtitle').textContent = p.subtitle || '';
                document.getElementById('post-view-content').textContent = p.content || '';
                document.getElementById('video-iframe').src = getDriveEmbedLink(p.videoURL);
                const pdfBtn = document.getElementById('post-view-pdf-btn');
                if(p.pdfURL) {
                    pdfBtn.href = p.pdfURL;
                    pdfBtn.classList.remove('hidden');
                } else {
                    pdfBtn.classList.add('hidden');
                }
                const compBtn = document.getElementById('mark-complete-btn');
                if(completedPosts.includes(id)) {
                    compBtn.className = "w-full bg-primary-900/10 border border-primary-500/30 text-gray-500 py-4 font-display font-bold uppercase tracking-[0.2em] text-[10px] cursor-default flex items-center justify-center gap-3";
                    compBtn.innerHTML = '<i class="fas fa-crown"></i> Conhecimento Absorvido';
                    compBtn.onclick = null;
                } else {
                    compBtn.className = "w-full bg-transparent border border-primary-500 text-primary-400 hover:bg-primary-500 hover:text-black py-4 font-display font-bold uppercase tracking-[0.2em] text-[10px] transition transform hover:scale-105 flex items-center justify-center gap-3";
                    compBtn.innerHTML = '<i class="fas fa-check-circle text-lg"></i> Consagrar Leitura';
                    compBtn.onclick = markComplete;
                }
                
                document.getElementById('post-view-delete-btn').onclick = async () => {
                    if(confirm("Apagar este registro sagrado?")) {
                        await deleteDoc(doc(db, "posts", id));
                        showView('blog-view');
                    }
                };

                loadComments(id);
                showView('post-view');
            }
            loadingSpinner.classList.add('hidden');
        }

        document.getElementById('back-to-posts-btn').addEventListener('click', () => {
            document.getElementById('video-iframe').src = "";
            showView('blog-view');
        });

        async function markComplete() {
            if(!currentUser || !currentPostId) return alert("Identifique-se primeiro.");
            try {
                // AGORA SALVAMOS TAMB√âM A DATA DE CONCLUS√ÉO
                await updateDoc(doc(db, "users", currentUser.uid), { 
                    completedPosts: arrayUnion(currentPostId),
                    [`completionDates.${currentPostId}`]: new Date() // Timestamp para a l√≥gica de tempo
                });
                
                if(!completedPosts.includes(currentPostId)) completedPosts.push(currentPostId);
                
                // Atualiza o objeto local tamb√©m para refletir imediatamente sem recarregar
                if(currentUserData) {
                    if(!currentUserData.completionDates) currentUserData.completionDates = {};
                    currentUserData.completionDates[currentPostId] = { toDate: () => new Date() }; // Simula timestamp do Firestore
                }

                openPost(currentPostId);
            } catch(e) { console.error(e); }
        }

        function loadComments(postId) {
            if(commentsUnsubscribe) commentsUnsubscribe();
            commentsUnsubscribe = onSnapshot(query(collection(db, "comments"), where("postId", "==", postId)), (snap) => {
                const list = document.getElementById('comments-list');
                list.innerHTML = '';
                if(snap.empty) { list.innerHTML = '<p class="text-gray-700 font-display text-[10px] uppercase tracking-widest text-center">O sil√™ncio impera.</p>'; return; }
                let comms = [];
                snap.forEach(d => comms.push({id: d.id, ...d.data()}));
                comms.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
                comms.forEach(c => {
                    const div = document.createElement('div');
                    div.className = "bg-white/5 p-6 border-l-2 border-primary-900";
                    div.innerHTML = `
                        <div class="flex justify-between mb-2">
                            <span class="text-primary-500 text-[10px] font-bold uppercase tracking-widest">${c.userName}</span>
                            <span class="text-gray-600 text-[9px]">${new Date(c.createdAt?.toDate()).toLocaleDateString()}</span>
                        </div>
                        <p class="text-gray-400 text-sm font-light italic">"${c.content}"</p>
                    `;
                    list.appendChild(div);
                });
            });
        }

        document.getElementById('submit-comment-btn').addEventListener('click', async () => {
            const txt = document.getElementById('comment-input').value;
            if(!currentUser || !txt) return;
            await addDoc(collection(db, "comments"), {
                postId: currentPostId,
                userName: currentUser.email.split('@')[0],
                content: txt,
                createdAt: new Date()
            });
            document.getElementById('comment-input').value = '';
        });

    </script>
</body>
</html>
